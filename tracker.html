<!-- tracker.html ‚Äî Poker Tracker (Key Player & Table Manager)
     VERSION: See version.js for current version
     ‚ö†Ô∏è Do not modify version here - use version.js instead
-->
<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Tracker - Key Player & Table Manager</title>
<style>
:root{
  font-size:clamp(15px,4.8vw,20px);
  --sp-xs:clamp(3px,0.8vw,6px);
  --sp-sm:clamp(6px,1.5vw,10px);
  --sp-md:clamp(8px,2vw,14px);
  --sp-lg:clamp(12px,3vw,20px);
  --bg:#0b0d12;--panel:#101522;--line:#1f2435;--muted:#9aa3b2;--acc:#2a6fff;--text:#e7eaf0;--green:#22c55e;--red:#ef4444
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;display:flex;flex-direction:column}
header{padding:var(--sp-sm) var(--sp-md);background:#0f1320;border-bottom:1px solid #2a3249;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;font-size:.95rem}
.wrap{padding:var(--sp-sm);flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--sp-md);padding:var(--sp-md);margin-bottom:var(--sp-sm)}
h2{margin:0 0 var(--sp-sm);color:#a9b8ff;font-size:1rem}
.small{font-size:.8rem}.muted{color:var(--muted)}
.hidden{display:none !important}

/* === Key Player Card === */
.keyPlayerCard{background:var(--panel);border:1px solid var(--line);border-radius:var(--sp-md);padding:var(--sp-md);margin-bottom:var(--sp-sm);display:flex;flex-direction:column;gap:var(--sp-sm)}
.cardRow{display:grid;grid-template-columns:auto 1fr auto;gap:var(--sp-sm);align-items:center}
.playerInfo{display:flex;align-items:center;gap:var(--sp-xs);overflow:hidden}
.tableLabel{background:#223266;padding:var(--sp-xs) var(--sp-sm);border-radius:var(--sp-xs);font-size:1.5rem;font-weight:700;flex-shrink:0}
.playerName{font-size:1.7rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.flag{font-size:1.7rem;flex-shrink:0}
.chipInfo{display:flex;align-items:center;gap:var(--sp-xs)}
.chips{font-size:2.1rem;font-weight:800;cursor:pointer;color:var(--acc);position:relative;padding:0 2px}
.chips::before,.chips::after{content:'‚îÉ';color:var(--acc);opacity:0.4}
.chipChange{font-size:1.7rem;font-weight:700}
.chipChange.up{color:var(--green)}
.chipChange.up::before{content:'‚ñ≤ '}
.chipChange.down{color:var(--red)}
.chipChange.down::before{content:'‚ñº '}
.chipChange.same{color:var(--muted)}
.manageBtn{display:none}

/* === Table View === */
#viewTable .wrap{display:flex;flex-direction:column;height:100%}
#tablePlayerList{display:flex;flex-direction:column;gap:0;flex:1}
.backBtn{background:transparent;border:none;color:var(--acc);font-size:.9rem;cursor:pointer;padding:var(--sp-sm);margin-bottom:var(--sp-sm);flex-shrink:0}
.playerRow{background:var(--panel);border:2px solid var(--line);border-radius:var(--sp-md);padding:var(--sp-lg);display:flex;align-items:center;gap:var(--sp-md);flex:1;min-height:0}
.playerRow.keyplayer{border-color:gold;box-shadow:0 0 12px rgba(255,215,0,0.4)}
.playerRow:not(:last-child){margin-bottom:4px}
.seat{font-weight:800;font-size:1.56rem;min-width:40px;background:var(--acc);color:var(--bg);padding:6px 12px;border-radius:6px}
.name{flex:1;font-weight:700;font-size:1.69rem}
.flag{font-size:1.95rem}
.chips{font-size:1.95rem;font-weight:800;color:var(--acc);cursor:pointer;position:relative;padding:0 4px}
.chips::before,.chips::after{content:'‚îÉ';opacity:0.4}
.keyStar{color:#fbbf24;font-size:1.56rem;margin-left:6px}
.emptySeat{flex:1;color:var(--muted);font-style:italic;font-size:1.43rem}
.addBtn{background:#223266;border:1px solid var(--acc);color:var(--acc);border-radius:var(--sp-sm);padding:var(--sp-sm) var(--sp-lg);font-size:1.3rem;cursor:pointer}
.deleteBtn{background:transparent;border:none;font-size:1.82rem;cursor:pointer;padding:var(--sp-sm)}

/* === Overlay === */
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:100}
#overlay.show{display:flex}
.overlayBox{width:min(440px,90vw);background:#0f1320;border:1px solid #2a3249;border-radius:var(--sp-md);padding:var(--sp-lg)}
.overlayTitle{font-size:1.8rem;font-weight:700;margin-bottom:var(--sp-md);color:#a9b8ff}
.overlayInput{width:100%;background:#0b0d12;color:var(--text);border:1px solid #2a3249;border-radius:var(--sp-sm);padding:var(--sp-lg);font-size:1.6rem;margin-bottom:var(--sp-md);min-height:56px}
.overlayInput:focus{outline:2px solid var(--acc)}
.overlayActions{display:flex;gap:var(--sp-md);margin-top:var(--sp-md)}
.btnCancel{background:#2a3249;border:1px solid #2a3249;color:var(--text);border-radius:var(--sp-sm);padding:var(--sp-lg);font-size:1.4rem;flex:1;cursor:pointer;min-height:56px}
.btnConfirm{background:var(--acc);border:1px solid var(--acc);color:#fff;border-radius:var(--sp-sm);padding:var(--sp-lg);font-size:1.4rem;flex:1;cursor:pointer;font-weight:700;min-height:56px}

/* === Poker Room/Table Name === */
.roomTableInfo{font-family:'Roboto',system-ui,sans-serif;font-size:.7rem;font-weight:600;text-align:left;background:linear-gradient(135deg,#1e2a45,#2a3556);color:#cbd5e1;padding:var(--sp-xs) var(--sp-md);border-radius:var(--sp-sm);margin-bottom:var(--sp-sm);border:1px solid #3a4a6f;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:block}

/* === Player Photo (Phase 3.1) === */
.keyPlayerCardPro{background:linear-gradient(135deg,#1a1d2e,#252a42);border:2px solid #3a4a6f;border-radius:var(--sp-md);padding:var(--sp-md);margin-bottom:var(--sp-sm);display:flex;gap:var(--sp-md);align-items:center;cursor:pointer;transition:all .2s}
.keyPlayerCardPro:hover{border-color:#4a5a8f;transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.4)}
.playerPhotoPro{width:96px;height:96px;border-radius:var(--sp-sm);object-fit:cover;border:2px solid #3a4a6f;flex-shrink:0;background:#0b0d12}
.playerPhotoPro.empty{display:flex;align-items:center;justify-content:center;font-size:2.5rem;color:var(--muted)}
.playerDetailsPro{flex:1;display:flex;flex-direction:column;gap:var(--sp-xs);min-width:0}
.playerNamePro{font-size:1.8rem;font-weight:800;color:#e7eaf0;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.playerMetaPro{display:flex;align-items:center;gap:var(--sp-sm);font-size:1.3rem;color:#9aa3b2;flex-wrap:wrap}
.playerMetaPro .icon{margin-right:2px}
.countryNamePro{font-weight:600;color:#a9b8ff}
.chipsEditBtn{background:transparent;border:1px solid var(--acc);color:var(--acc);padding:var(--sp-xs) var(--sp-sm);border-radius:var(--sp-xs);font-size:1.1rem;cursor:pointer;font-weight:600;margin-left:auto}
.photoEditBtn{background:transparent;border:1px solid #6b7280;color:#9aa3b2;padding:var(--sp-xs) var(--sp-sm);border-radius:var(--sp-xs);font-size:1.1rem;cursor:pointer;align-self:flex-start}

/* === Loading === */
.loading{text-align:center;padding:var(--sp-lg);color:var(--muted)}
.error{background:#b91c1c;color:#ffe5e5;padding:var(--sp-md);border-radius:var(--sp-sm);margin-bottom:var(--sp-md);font-size:.9rem}
</style>
</head>
<body>
<header>
  <div><strong>üéØ Tracker</strong></div>
  <div><span class="muted small" id="keyCountHeader">Key Players (0)</span></div>
</header>

<div class="wrap">
  <!-- Key Player View -->
  <div id="viewKeyPlayers">
    <div id="keyPlayerList" class="loading">Î°úÎî© Ï§ë...</div>
  </div>

  <!-- Table View -->
  <div id="viewTable" class="hidden">
    <button class="backBtn">‚Üê Back</button>
    <div class="panel">
      <h2 id="tableTitle">T##</h2>
      <div id="tablePlayerList"></div>
    </div>
  </div>
</div>

<!-- Overlay -->
<div id="overlay">
  <div class="overlayBox">
    <div id="overlayContent"></div>
  </div>
</div>

<script>
/* ===== Version Management ===== */
// version.jsÏóêÏÑú Î≤ÑÏ†Ñ Ï†ïÎ≥¥ Î°úÎìú (Î∏åÎùºÏö∞Ï†Ä ÌôòÍ≤Ω)
if (typeof window.TRACKER_VERSION !== 'undefined') {
  const versionEl = document.getElementById('appVersion');
  if (versionEl && window.TRACKER_VERSION.current) {
    versionEl.textContent = ' ' + window.TRACKER_VERSION.current;
  }
}

/* ===== Helper Functions ===== */
// ÌÖåÏù¥Î∏î Î≤àÌò∏: Ïà´Ïûê ‚Üí "T15" ÌòïÏãù Î≥ÄÌôò
function formatTableNo(num) {
  return `T${num}`;
}

// Ï¢åÏÑù Î≤àÌò∏: Ïà´Ïûê ‚Üí "S3" ÌòïÏãù Î≥ÄÌôò
function formatSeatNo(num) {
  return `S${num}`;
}

// ÌÖåÏù¥Î∏î Î≤àÌò∏: "T15" ÎòêÎäî "15" ‚Üí Ïà´Ïûê Î≥ÄÌôò
function parseTableNo(str) {
  const s = String(str).toUpperCase().trim();
  if (!isNaN(s)) return parseInt(s);
  if (s.startsWith('T')) return parseInt(s.substring(1));
  return 0;
}

// Ï¢åÏÑù Î≤àÌò∏: "S3" ÎòêÎäî "3" ‚Üí Ïà´Ïûê Î≥ÄÌôò
function parseSeatNo(str) {
  const s = String(str).toUpperCase().trim();
  if (!isNaN(s)) return parseInt(s);
  if (s.startsWith('S')) return parseInt(s.substring(1));
  return 0;
}

// Íµ≠Í∞Ä ÏΩîÎìú ‚Üí Íµ≠Í∞ÄÎ™Ö (40Í∞úÍµ≠)
function getCountryName(code) {
  const map = {
    'KR': 'South Korea', 'US': 'USA', 'CN': 'China', 'JP': 'Japan', 'GB': 'England',
    'DE': 'Germany', 'FR': 'France', 'IT': 'Italy', 'ES': 'Spain', 'PT': 'Portugal',
    'BR': 'Brazil', 'AR': 'Argentina', 'MX': 'Mexico', 'CA': 'Canada', 'AU': 'Australia',
    'NZ': 'New Zealand', 'RU': 'Russia', 'UA': 'Ukraine', 'PL': 'Poland', 'CZ': 'Czech Republic',
    'SE': 'Sweden', 'NO': 'Norway', 'FI': 'Finland', 'DK': 'Denmark', 'NL': 'Netherlands',
    'BE': 'Belgium', 'CH': 'Switzerland', 'AT': 'Austria', 'GR': 'Greece', 'TR': 'Turkey',
    'IL': 'Israel', 'AE': 'UAE', 'IN': 'India', 'TH': 'Thailand', 'VN': 'Vietnam',
    'PH': 'Philippines', 'ID': 'Indonesia', 'MY': 'Malaysia', 'SG': 'Singapore', 'HK': 'Hong Kong'
  };
  return map[String(code).toUpperCase()] || code;
}

/* ===== State ===== */
let currentView = 'key'; // 'key' | 'table'
let currentTableId = null;
let keyPlayers = [];

/* ===== Init ===== */
window.onload = () => {
  loadKeyPlayers();

  // Back Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
  const backBtn = document.querySelector('.backBtn');
  if (backBtn) {
    backBtn.addEventListener('click', showKeyPlayerView);
  }
};

/* ===== View Switching ===== */
function showKeyPlayerView() {
  document.getElementById('viewKeyPlayers').classList.remove('hidden');
  document.getElementById('viewTable').classList.add('hidden');
  currentView = 'key';
  currentTableId = null;
}

function showTableView(tableId) {
  // Í∏∞Ï°¥ roomTableInfo Ï†úÍ±∞
  const oldInfo = document.querySelector('#viewTable .roomTableInfo');
  if (oldInfo) oldInfo.remove();

  document.getElementById('viewKeyPlayers').classList.add('hidden');
  document.getElementById('viewTable').classList.remove('hidden');
  document.getElementById('tableTitle').textContent = formatTableNo(tableId);
  currentView = 'table';
  currentTableId = tableId;
  loadTablePlayers(tableId);
}

/* ===== Key Player View ===== */
function loadKeyPlayers() {
  const list = document.getElementById('keyPlayerList');
  list.innerHTML = '<div class="loading">Î°úÎî© Ï§ë...</div>';

  google.script.run
    .withSuccessHandler(response => {
      if (!response.success) {
        list.innerHTML = `<div class="error">ÏóêÎü¨: ${response.error?.message || 'Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®'}</div>`;
        return;
      }
      const players = response.data.players;

      // ÎîîÎ≤ÑÍπÖ: Ï≤´ Î≤àÏß∏ ÌîåÎ†àÏù¥Ïñ¥ Îç∞Ïù¥ÌÑ∞ Ï†ÑÏ≤¥ Ï∂úÎ†•
      console.log('=== getKeyPlayers ÏùëÎãµ ===');
      console.log('Ï†ÑÏ≤¥ ÌîåÎ†àÏù¥Ïñ¥ Ïàò:', players.length);
      if (players.length > 0) {
        console.log('Ï≤´ Î≤àÏß∏ ÌîåÎ†àÏù¥Ïñ¥ Îç∞Ïù¥ÌÑ∞:', players[0]);
        console.log('photoUrl ÌïÑÎìú:', players[0].photoUrl);
        console.log('photoUrl ÌÉÄÏûÖ:', typeof players[0].photoUrl);
      }

      keyPlayers = players;
      renderKeyPlayers(players);
    })
    .withFailureHandler(err => {
      list.innerHTML = `<div class="error">ÏóêÎü¨: ${err.message}</div>`;
    })
    .getKeyPlayers();
}

function renderKeyPlayers(players) {
  const list = document.getElementById('keyPlayerList');
  const countHeader = document.getElementById('keyCountHeader');

  if (players.length === 0) {
    list.innerHTML = '<div class="muted small">ÌÇ§ ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
    countHeader.textContent = 'Key Players (0)';
    return;
  }

  list.innerHTML = '';
  countHeader.textContent = `Key Players (${players.length})`;

  players.forEach(p => {
    const card = document.createElement('div');
    card.className = 'keyPlayerCardPro';

    // Íµ≠Í∞ÄÎ™Ö
    const countryName = getCountryName(p.nationality);

    // Ïπ© ÏâºÌëú Ìè¨Îß∑
    const chipsFormatted = formatChips(p.chipCount);

    // Ïπ¥Îìú Íµ¨Ï°∞ ÏÉùÏÑ± (ÏÇ¨ÏßÑ Î∞è Ïù¥Î≤§Ìä∏ Ï†úÏô∏)
    card.innerHTML = `
      <div class="roomTableInfo">${formatRoomTableInfo(p.pokerRoom, p.tableName, p.tableNo)}</div>
      <div class="photoContainer"></div>
      <div class="playerDetailsPro">
        <div class="playerNamePro">${p.playerName}</div>
        <div class="playerMetaPro">
          <span><span class="icon">üìç</span>${formatTableNo(p.tableNo)}, ${formatSeatNo(p.seatNo)}</span>
          <span class="countryNamePro">${getFlag(p.nationality)} ${countryName}</span>
          <span><span class="icon">üí∞</span>${chipsFormatted} chips</span>
        </div>
        <button class="photoEditBtn">üì∑ ÏÇ¨ÏßÑ Ìé∏Ïßë</button>
      </div>
    `;

    // Ïπ¥Îìú ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÌÖåÏù¥Î∏î Î∑∞Î°ú Ïù¥Îèô)
    card.addEventListener('click', () => showTableView(p.tableNo));

    // ÏÇ¨ÏßÑ Ìé∏Ïßë Î≤ÑÌäº Ïù¥Î≤§Ìä∏ (DOMÏúºÎ°ú ÏïàÏ†ÑÌïòÍ≤å Ïó∞Í≤∞)
    const photoEditBtn = card.querySelector('.photoEditBtn');
    photoEditBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      editPlayerPhoto(p.playerName, p.photoUrl || '');
    });

    // ÏÇ¨ÏßÑ ÏöîÏÜåÎ•º DOMÏúºÎ°ú ÏßÅÏ†ë ÏÉùÏÑ± (innerHTML ÏÇ¨Ïö© Ïïà Ìï®)
    const photoContainer = card.querySelector('.photoContainer');

    if (p.photoUrl && p.photoUrl.trim()) {
      // Imgur URLÏùÑ ÏßÅÏ†ë Ïù¥ÎØ∏ÏßÄ ÎßÅÌÅ¨Î°ú ÏûêÎèô Î≥ÄÌôò
      const directImageUrl = convertToDirectImageUrl(p.photoUrl);

      // img ÏöîÏÜå ÏÉùÏÑ±
      const img = document.createElement('img');
      img.src = directImageUrl;
      img.className = 'playerPhotoPro';
      img.alt = p.playerName;
      img.crossOrigin = 'anonymous';
      img.loading = 'lazy';

      img.onerror = function() {
        console.error('Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®:', this.src);
        this.style.display = 'none';
        if (this.nextElementSibling) this.nextElementSibling.style.display = 'flex';
      };

      img.onload = function() {
        console.log('Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏÑ±Í≥µ:', this.src);
        this.style.display = 'block';
        if (this.nextElementSibling) this.nextElementSibling.style.display = 'none';
      };

      // fallback div ÏÉùÏÑ±
      const fallback = document.createElement('div');
      fallback.className = 'playerPhotoPro empty';
      fallback.style.display = 'none';
      fallback.title = 'Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®';
      fallback.textContent = 'üë§';

      photoContainer.appendChild(img);
      photoContainer.appendChild(fallback);
    } else {
      // URLÏù¥ ÏóÜÏùÑ Îïå: Í∏∞Î≥∏ ÏïÑÏù¥ÏΩò
      const emptyPhoto = document.createElement('div');
      emptyPhoto.className = 'playerPhotoPro empty';
      emptyPhoto.title = 'ÏÇ¨ÏßÑ URL ÏóÜÏùå (Type ÏãúÌä∏ NÏó¥ ÌôïÏù∏)';
      emptyPhoto.textContent = 'üë§';
      photoContainer.appendChild(emptyPhoto);
    }

    list.appendChild(card);
  });
}

/* ===== Table View ===== */
function loadTablePlayers(tableId) {
  const list = document.getElementById('tablePlayerList');
  list.innerHTML = '<div class="loading">Î°úÎî© Ï§ë...</div>';

  google.script.run
    .withSuccessHandler(response => {
      if (!response.success) {
        list.innerHTML = `<div class="error">ÏóêÎü¨: ${response.error?.message || 'Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®'}</div>`;
        return;
      }
      const players = response.data.players;
      renderTablePlayers(tableId, players);
    })
    .withFailureHandler(err => {
      list.innerHTML = `<div class="error">ÏóêÎü¨: ${err.message}</div>`;
    })
    .getTablePlayers(tableId);
}

function renderTablePlayers(tableId, players) {
  const list = document.getElementById('tablePlayerList');
  list.innerHTML = '';

  // tableTitle h2 ÏïûÏóê roomTableInfo div ÏÇΩÏûÖ
  const titleElement = document.getElementById('tableTitle');
  let roomInfo = document.querySelector('#viewTable .roomTableInfo');
  if (!roomInfo) {
    roomInfo = document.createElement('div');
    roomInfo.className = 'roomTableInfo';
    titleElement.parentNode.insertBefore(roomInfo, titleElement);
  }
  roomInfo.textContent = formatRoomTableInfo(players[0]?.pokerRoom, players[0]?.tableName, tableId);

  players.forEach(p => {
    const row = document.createElement('div');
    row.className = p.keyplayer ? 'playerRow keyplayer' : 'playerRow';

    if (p.empty) {
      row.innerHTML = `
        <span class="seat">${formatSeatNo(p.seatNo)}</span>
        <span class="emptySeat">(Îπà Ï¢åÏÑù)</span>
        <button class="addBtn">[+]</button>
      `;

      // Ïù¥Î≤§Ìä∏ ÏïàÏ†ÑÌïòÍ≤å Ïó∞Í≤∞
      const addBtn = row.querySelector('.addBtn');
      addBtn.addEventListener('click', () => addPlayerPrompt(tableId, p.seatNo));

    } else {
      const keyStar = p.keyplayer ? '<span class="keyStar">‚≠ê</span>' : '';
      row.innerHTML = `
        <span class="seat">${formatSeatNo(p.seatNo)}</span>
        <span class="name">${p.playerName}${keyStar}</span>
        <span class="flag">${getFlag(p.nationality)}</span>
        <span class="chips">${formatChips(p.chipCount)}</span>
        <button class="deleteBtn">üóëÔ∏è</button>
      `;

      // Ïù¥Î≤§Ìä∏ ÏïàÏ†ÑÌïòÍ≤å Ïó∞Í≤∞ (DOM API)
      const chipsSpan = row.querySelector('.chips');
      chipsSpan.style.cursor = 'pointer';
      chipsSpan.addEventListener('click', () => {
        editChips(tableId, p.seatNo, p.chipCount, p.playerName);
      });

      const deleteBtn = row.querySelector('.deleteBtn');
      deleteBtn.addEventListener('click', () => {
        deletePlayerConfirm(tableId, p.seatNo, p.playerName);
      });
    }

    list.appendChild(row);
  });
}

/* ===== Edit Chips ===== */
function editChips(tableId, seatNo, currentChips, playerName) {
  const overlay = document.getElementById('overlay');
  const content = document.getElementById('overlayContent');

  content.innerHTML = `
    <div class="overlayTitle">${formatSeatNo(seatNo)} ${playerName} Ïπ© ÏàòÏ†ï</div>
    <div class="muted" style="font-size:1.2rem;margin-bottom:var(--sp-md)">ÌòÑÏû¨: ${formatChips(currentChips)}</div>
    <input type="text" id="chipInput" class="overlayInput" placeholder="Ïòà: 750000 ÎòêÎäî 750k" autocomplete="off" inputmode="decimal">
    <div class="overlayActions">
      <button class="btnCancel">Ï∑®ÏÜå</button>
      <button class="btnConfirm">ÌôïÏù∏</button>
    </div>
  `;

  // Ïù¥Î≤§Ìä∏ ÏïàÏ†ÑÌïòÍ≤å Ïó∞Í≤∞
  const btnCancel = content.querySelector('.btnCancel');
  const btnConfirm = content.querySelector('.btnConfirm');

  btnCancel.addEventListener('click', closeOverlay);
  btnConfirm.addEventListener('click', () => confirmEditChips(tableId, seatNo, currentChips));

  overlay.classList.add('show');
  setTimeout(() => document.getElementById('chipInput').focus(), 100);
}

function confirmEditChips(tableId, seatNo, oldChips) {
  const input = document.getElementById('chipInput').value.trim();
  if (!input) {
    alert('Ïπ©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
    return;
  }

  const newChips = parseChips(input);
  if (newChips === null || newChips < 0) {
    alert('Ïò¨Î∞îÎ•∏ Ïà´ÏûêÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: 750000 ÎòêÎäî 750k)');
    return;
  }

  closeOverlay();
  showLoading();

  google.script.run
    .withSuccessHandler(response => {
      if (!response.success) {
        alert('ÏóêÎü¨: ' + (response.error?.message || 'Ïπ© ÏàòÏ†ï Ïã§Ìå®'));
        hideLoading();
        return;
      }
      saveChipHistory(tableId, seatNo, newChips);
      if (currentView === 'key') {
        loadKeyPlayers();
      } else {
        loadTablePlayers(currentTableId);
      }
    })
    .withFailureHandler(err => {
      alert('ÏóêÎü¨: ' + err.message);
      hideLoading();
    })
    .updatePlayerChips(tableId, seatNo, newChips);
}

/* ===== Add Player ===== */
function addPlayerPrompt(tableId, seatNo) {
  const overlay = document.getElementById('overlay');
  const content = document.getElementById('overlayContent');

  content.innerHTML = `
    <div class="overlayTitle">${seatNo} ÌîåÎ†àÏù¥Ïñ¥ Ï∂îÍ∞Ä</div>
    <input type="text" id="nameInput" class="overlayInput" placeholder="Ïù¥Î¶Ñ" autocomplete="off">
    <input type="text" id="nationInput" class="overlayInput" placeholder="Íµ≠Í∞Ä ÏΩîÎìú (Ïòà: KR, US, JP)" autocomplete="off" maxlength="2" style="text-transform:uppercase">
    <input type="text" id="chipsInput" class="overlayInput" placeholder="Ïπ© (Ïòà: 280000 ÎòêÎäî 280k)" autocomplete="off" inputmode="decimal">
    <label style="display:flex;align-items:center;gap:var(--sp-md);margin-bottom:var(--sp-md)">
      <input type="checkbox" id="keyInput" style="width:32px;height:32px;cursor:pointer">
      <span style="font-size:1.4rem">ÌÇ§ ÌîåÎ†àÏù¥Ïñ¥Î°ú Îì±Î°ù</span>
    </label>
    <div class="overlayActions">
      <button class="btnCancel">Ï∑®ÏÜå</button>
      <button class="btnConfirm">Ï∂îÍ∞Ä</button>
    </div>
  `;

  // Ïù¥Î≤§Ìä∏ ÏïàÏ†ÑÌïòÍ≤å Ïó∞Í≤∞
  const btnCancel = content.querySelector('.btnCancel');
  const btnConfirm = content.querySelector('.btnConfirm');

  btnCancel.addEventListener('click', closeOverlay);
  btnConfirm.addEventListener('click', () => confirmAddPlayer(tableId, seatNo));

  overlay.classList.add('show');
  setTimeout(() => document.getElementById('nameInput').focus(), 100);
}

function confirmAddPlayer(tableId, seatNo) {
  const name = document.getElementById('nameInput').value.trim();
  const nation = document.getElementById('nationInput').value.trim().toUpperCase();
  const chipsInput = document.getElementById('chipsInput').value.trim();
  const isKey = document.getElementById('keyInput').checked;

  if (!name) {
    alert('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
    return;
  }
  if (!nation) {
    alert('Íµ≠Í∞Ä ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
    return;
  }
  if (!chipsInput) {
    alert('Ïπ©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
    return;
  }

  const chips = parseChips(chipsInput);
  if (chips === null || chips < 0) {
    alert('Ïò¨Î∞îÎ•∏ Ïπ© Ïà´ÏûêÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
    return;
  }

  closeOverlay();
  showLoading();

  google.script.run
    .withSuccessHandler(response => {
      if (!response.success) {
        alert('ÏóêÎü¨: ' + (response.error?.message || 'ÌîåÎ†àÏù¥Ïñ¥ Ï∂îÍ∞Ä Ïã§Ìå®'));
        hideLoading();
        return;
      }
      if (currentView === 'key' && isKey) {
        loadKeyPlayers();
      } else {
        loadTablePlayers(currentTableId);
      }
    })
    .withFailureHandler(err => {
      alert('ÏóêÎü¨: ' + err.message);
      hideLoading();
    })
    .addPlayer(tableId, seatNo, name, nation, chips, isKey);
}

/* ===== Delete Player ===== */
function deletePlayerConfirm(tableId, seatNo, playerName) {
  if (!confirm(seatNo + ' ' + playerName + ' ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

  showLoading();

  google.script.run
    .withSuccessHandler(response => {
      if (!response.success) {
        alert('ÏóêÎü¨: ' + (response.error?.message || 'ÌîåÎ†àÏù¥Ïñ¥ ÏÇ≠Ï†ú Ïã§Ìå®'));
        hideLoading();
        return;
      }
      if (currentView === 'key') {
        loadKeyPlayers();
      } else {
        loadTablePlayers(currentTableId);
      }
    })
    .withFailureHandler(err => {
      alert('ÏóêÎü¨: ' + err.message);
      hideLoading();
    })
    .removePlayer(tableId, seatNo);
}

/* ===== Player Photo Edit (Phase 3.1) ===== */
function editPlayerPhoto(playerName, currentPhotoUrl) {
  const overlay = document.getElementById('overlay');
  const content = document.getElementById('overlayContent');

  content.innerHTML = `
    <div class="overlayTitle">üì∑ ${playerName} ÏÇ¨ÏßÑ Ìé∏Ïßë</div>
    <input type="text" id="photoUrlInput" class="overlayInput" placeholder="https://i.imgur.com/abc123.jpg" value="${currentPhotoUrl}">
    <div style="font-size: 1.1rem; color: #9aa3b2; margin-top: -8px; margin-bottom: 12px;">
      üí° <a href="https://imgur.com/" target="_blank" style="color: #2a6fff;">Imgur</a>Ïóê ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú ÌõÑ HTTPS URL ÏûÖÎ†•
    </div>
    <div class="overlayActions">
      <button class="btnCancel">Ï∑®ÏÜå</button>
      <button class="btnConfirm">Ï†ÄÏû•</button>
    </div>
  `;

  // Ïù¥Î≤§Ìä∏ ÏïàÏ†ÑÌïòÍ≤å Ïó∞Í≤∞
  const btnCancel = content.querySelector('.btnCancel');
  const btnConfirm = content.querySelector('.btnConfirm');

  btnCancel.addEventListener('click', closeOverlay);
  btnConfirm.addEventListener('click', () => confirmPhotoEdit(playerName));

  overlay.classList.add('show');

  // Ìè¨Ïª§Ïä§
  setTimeout(() => {
    const input = document.getElementById('photoUrlInput');
    if (input) input.focus();
  }, 100);
}

function confirmPhotoEdit(playerName) {
  const input = document.getElementById('photoUrlInput');
  let photoUrl = input.value.trim();

  if (!photoUrl) {
    alert('ÏÇ¨ÏßÑ URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
    return;
  }

  if (!photoUrl.startsWith('https://') && !photoUrl.startsWith('http://')) {
    alert('HTTP(S)Î°ú ÏãúÏûëÌïòÎäî URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
    return;
  }

  // Imgur URL ÏûêÎèô Î≥ÄÌôò Î∞è ÏÇ¨Ïö©Ïûê ÏïàÎÇ¥
  const directUrl = convertToDirectImageUrl(photoUrl);
  if (directUrl !== photoUrl) {
    const confirmed = confirm(
      `Imgur ÌéòÏù¥ÏßÄ URLÏù¥ Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§.\n\n` +
      `ÏõêÎ≥∏: ${photoUrl}\n` +
      `Î≥ÄÌôò: ${directUrl}\n\n` +
      `ÏßÅÏ†ë Ïù¥ÎØ∏ÏßÄ ÎßÅÌÅ¨Î°ú Î≥ÄÌôòÌïòÏó¨ Ï†ÄÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`
    );
    if (confirmed) {
      photoUrl = directUrl;
    }
  }

  closeOverlay();
  showLoading();

  google.script.run
    .withSuccessHandler(response => {
      if (!response.success) {
        alert('ÏóêÎü¨: ' + (response.error?.message || 'ÏÇ¨ÏßÑ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®'));
        hideLoading();
        return;
      }
      loadKeyPlayers();
    })
    .withFailureHandler(err => {
      alert('ÏóêÎü¨: ' + err.message);
      hideLoading();
    })
    .updateKeyPlayerPhoto(playerName, photoUrl);
}

/* ===== Utilities ===== */
/**
 * Imgur URLÏùÑ ÏßÅÏ†ë Ïù¥ÎØ∏ÏßÄ ÎßÅÌÅ¨Î°ú Î≥ÄÌôò
 * @param {string} url - ÏõêÎ≥∏ URL
 * @return {string} Î≥ÄÌôòÎêú URL
 */
function convertToDirectImageUrl(url) {
  if (!url || !url.trim()) return '';

  const trimmedUrl = url.trim();

  // Ïù¥ÎØ∏ ÏßÅÏ†ë Ïù¥ÎØ∏ÏßÄ ÎßÅÌÅ¨Î©¥ Í∑∏ÎåÄÎ°ú Î∞òÌôò
  if (trimmedUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
    return trimmedUrl;
  }

  // Imgur ÌéòÏù¥ÏßÄ URL ‚Üí ÏßÅÏ†ë Ïù¥ÎØ∏ÏßÄ ÎßÅÌÅ¨ Î≥ÄÌôò
  // https://imgur.com/abc123 ‚Üí https://i.imgur.com/abc123.jpg
  const imgurMatch = trimmedUrl.match(/^https?:\/\/imgur\.com\/([a-zA-Z0-9]+)$/);
  if (imgurMatch) {
    const imageId = imgurMatch[1];
    console.log(`Imgur URL Î≥ÄÌôò: ${trimmedUrl} ‚Üí https://i.imgur.com/${imageId}.jpg`);
    return `https://i.imgur.com/${imageId}.jpg`;
  }

  // Í∏∞ÌÉÄ URLÏùÄ Í∑∏ÎåÄÎ°ú Î∞òÌôò
  return trimmedUrl;
}

/**
 * Poker Room, Table Name, Table NoÎ•º Ìè¨Îß∑ÌåÖ
 * @param {string} pokerRoom - Poker Room Ïù¥Î¶Ñ
 * @param {string} tableName - Table Name
 * @param {string} tableId - Table No (Ïòà: T1)
 * @return {string} "Merit Hall | Ocean Blue | T1" ÌòïÏãù
 */
function formatRoomTableInfo(pokerRoom, tableName, tableId) {
  const room = pokerRoom || '';
  const table = tableName || '';
  return `${room} | ${table} | ${tableId}`;
}

function parseChips(input) {
  if (!input) return null;
  const str = String(input).trim().toLowerCase();
  if (str.endsWith('k')) {
    const num = parseFloat(str.slice(0, -1));
    return isNaN(num) ? null : Math.round(num * 1000);
  }
  const num = parseFloat(str.replace(/[^\d.]/g, ''));
  return isNaN(num) ? null : Math.round(num);
}

function formatChips(chips) {
  if (chips >= 1000) {
    return Math.round(chips / 1000) + 'k';
  }
  return chips.toString();
}

function getFlag(nationCode) {
  const flags = {
    'KR': 'üá∞üá∑', 'US': 'üá∫üá∏', 'JP': 'üáØüáµ', 'CN': 'üá®üá≥', 'GB': 'üá¨üáß',
    'FR': 'üá´üá∑', 'DE': 'üá©üá™', 'CA': 'üá®üá¶', 'AU': 'üá¶üá∫', 'TW': 'üáπüáº'
  };
  return flags[nationCode] || 'üåê';
}

function getChipChange(tableId, seatNo, currentChips) {
  const key = `${tableId}_${seatNo}`;
  const history = JSON.parse(localStorage.getItem('phl_chipHistory') || '{}');
  const oldChips = history[key] || currentChips;

  const diff = currentChips - oldChips;
  if (diff > 0) {
    return { amount: diff, direction: 'up', text: `‚Üë${formatChips(diff)}` };
  } else if (diff < 0) {
    return { amount: diff, direction: 'down', text: `‚Üì${formatChips(Math.abs(diff))}` };
  } else {
    return { amount: 0, direction: 'same', text: '' };
  }
}

function saveChipHistory(tableId, seatNo, chips) {
  const key = `${tableId}_${seatNo}`;
  const history = JSON.parse(localStorage.getItem('phl_chipHistory') || '{}');
  history[key] = chips;
  localStorage.setItem('phl_chipHistory', JSON.stringify(history));
}

function closeOverlay() {
  document.getElementById('overlay').classList.remove('show');
}

function showLoading() {
  const list = currentView === 'key'
    ? document.getElementById('keyPlayerList')
    : document.getElementById('tablePlayerList');
  list.innerHTML = '<div class="loading">Ï≤òÎ¶¨ Ï§ë...</div>';
}

function hideLoading() {
  // Î¶¨Î†åÎçîÎßÅÏúºÎ°ú Ï≤òÎ¶¨Îê®
}
</script>
</body>
</html>