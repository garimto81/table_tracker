<!-- tracker.html ‚Äî Poker Tracker (Key Player & Table Manager)
     VERSION: See version.js for current version
     ‚ö†Ô∏è Do not modify version here - use version.js instead
-->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Tracker - Key Player & Table Manager</title>
<style>
:root{
  font-size:clamp(15px,4.8vw,20px);
  --sp-xs:clamp(3px,0.8vw,6px);
  --sp-sm:clamp(6px,1.5vw,10px);
  --sp-md:clamp(8px,2vw,14px);
  --sp-lg:clamp(12px,3vw,20px);
  --bg:#0b0d12;--panel:#101522;--line:#1f2435;--muted:#9aa3b2;--acc:#2a6fff;--text:#e7eaf0;--green:#22c55e;--red:#ef4444
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;display:flex;flex-direction:column}
header{padding:var(--sp-sm) var(--sp-md);background:#0f1320;border-bottom:1px solid #2a3249;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;font-size:.95rem}
.wrap{padding:var(--sp-sm);flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--sp-md);padding:var(--sp-md);margin-bottom:var(--sp-sm)}
h2{margin:0 0 var(--sp-sm);color:#a9b8ff;font-size:1rem}
.small{font-size:.8rem}.muted{color:var(--muted)}
.hidden{display:none !important}

/* === Key Player Card === */
.keyPlayerCard{background:var(--panel);border:1px solid var(--line);border-radius:var(--sp-md);padding:var(--sp-md);margin-bottom:var(--sp-sm);display:flex;flex-direction:column;gap:var(--sp-sm)}
.cardRow{display:grid;grid-template-columns:auto 1fr auto;gap:var(--sp-sm);align-items:center}
.playerInfo{display:flex;align-items:center;gap:var(--sp-xs);overflow:hidden}
.tableLabel{background:#223266;padding:var(--sp-xs) var(--sp-sm);border-radius:var(--sp-xs);font-size:1.5rem;font-weight:700;flex-shrink:0}
.playerName{font-size:1.7rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.flag{font-size:1.7rem;flex-shrink:0}
.chipInfo{display:flex;align-items:center;gap:var(--sp-xs)}
.chips{font-size:2.1rem;font-weight:800;cursor:pointer;color:var(--acc);position:relative;padding:0 2px}
.chips::before,.chips::after{content:'‚îÉ';color:var(--acc);opacity:0.4}
.chipChange{font-size:1.7rem;font-weight:700}
.chipChange.up{color:var(--green)}
.chipChange.up::before{content:'‚ñ≤ '}
.chipChange.down{color:var(--red)}
.chipChange.down::before{content:'‚ñº '}
.chipChange.same{color:var(--muted)}
.manageBtn{display:none}

/* === Table View === */
#viewTable .wrap{display:flex;flex-direction:column;height:100%}
#tablePlayerList{display:flex;flex-direction:column;gap:0;flex:1}
.backBtn{background:transparent;border:none;color:var(--acc);font-size:.9rem;cursor:pointer;padding:var(--sp-sm);margin-bottom:var(--sp-sm);flex-shrink:0}
.playerRow{background:var(--panel);border:2px solid var(--line);border-radius:var(--sp-md);padding:var(--sp-lg);display:flex;align-items:center;gap:var(--sp-md);flex:1;min-height:0}
.playerRow.keyplayer{border-color:gold;box-shadow:0 0 12px rgba(255,215,0,0.4)}
.playerRow:not(:last-child){margin-bottom:4px}
.seat{font-weight:800;font-size:1.56rem;min-width:40px;background:var(--acc);color:var(--bg);padding:6px 12px;border-radius:6px}
.name{flex:1;font-weight:700;font-size:1.69rem}
.flag{font-size:1.95rem}
.chips{font-size:1.95rem;font-weight:800;color:var(--acc);cursor:pointer;position:relative;padding:0 4px}
.chips::before,.chips::after{content:'‚îÉ';opacity:0.4}
.keyStar{color:#fbbf24;font-size:1.56rem;margin-left:6px}
.emptySeat{flex:1;color:var(--muted);font-style:italic;font-size:1.43rem}
.addBtn{background:#223266;border:1px solid var(--acc);color:var(--acc);border-radius:var(--sp-sm);padding:var(--sp-sm) var(--sp-lg);font-size:1.3rem;cursor:pointer}
.moveBtn{background:transparent;border:none;font-size:1.6rem;cursor:pointer;padding:var(--sp-sm);color:#f59e0b;transition:transform .2s}
.moveBtn:hover{transform:scale(1.2)}
.deleteBtn{background:transparent;border:none;font-size:1.82rem;cursor:pointer;padding:var(--sp-sm)}

/* === Overlay === */
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:100}
#overlay.show{display:flex}
.overlayBox{width:min(440px,90vw);background:#0f1320;border:1px solid #2a3249;border-radius:var(--sp-md);padding:var(--sp-lg)}
.overlayTitle{font-size:1.8rem;font-weight:700;margin-bottom:var(--sp-md);color:#a9b8ff}
.overlayInput{width:100%;background:#0b0d12;color:var(--text);border:1px solid #2a3249;border-radius:var(--sp-sm);padding:var(--sp-lg);font-size:1.6rem;margin-bottom:var(--sp-md);min-height:56px}
.overlayInput:focus{outline:2px solid var(--acc)}
.overlayActions{display:flex;gap:var(--sp-md);margin-top:var(--sp-md)}
.btnCancel{background:#2a3249;border:1px solid #2a3249;color:var(--text);border-radius:var(--sp-sm);padding:var(--sp-lg);font-size:1.4rem;flex:1;cursor:pointer;min-height:56px}
.btnConfirm{background:var(--acc);border:1px solid var(--acc);color:#fff;border-radius:var(--sp-sm);padding:var(--sp-lg);font-size:1.4rem;flex:1;cursor:pointer;font-weight:700;min-height:56px}

/* === Poker Room/Table Name === */
.roomTableInfo{font-family:'Roboto',system-ui,sans-serif;font-size:.7rem;font-weight:600;text-align:left;background:linear-gradient(135deg,#1e2a45,#2a3556);color:#cbd5e1;padding:var(--sp-xs) var(--sp-md);border-radius:var(--sp-sm);margin-bottom:var(--sp-sm);border:1px solid #3a4a6f;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:block}

/* === Player Photo (Phase 3.1) === */
.keyPlayerCardPro{background:linear-gradient(135deg,#1a1d2e,#252a42);border:2px solid #3a4a6f;border-radius:var(--sp-md);padding:var(--sp-md);margin-bottom:var(--sp-sm);display:flex;gap:var(--sp-md);align-items:center;cursor:pointer;transition:all .2s}
.keyPlayerCardPro:hover{border-color:#4a5a8f;transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.4)}

/* Phase 3.6.1: Feature ÌîåÎ†àÏù¥Ïñ¥ ÌùêÎ¶º Ï≤òÎ¶¨ */
.keyPlayerCardPro.feature{opacity:0.5;filter:grayscale(50%);pointer-events:none;position:relative}
.keyPlayerCardPro.feature::before{content:'üé¨ FEATURE TABLE';position:absolute;top:8px;right:8px;background:linear-gradient(135deg,#8b5cf6,#6366f1);color:#fff;padding:4px 12px;border-radius:12px;font-size:0.8rem;font-weight:bold;z-index:10}

/* Feature ÏÑπÏÖò Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞ */
.featureSection{margin-bottom:var(--sp-md)}
.featureSectionHeader{background:linear-gradient(135deg,#1e2a45,#2a3556);border:1px solid #3a4a6f;border-radius:var(--sp-md);padding:var(--sp-md);display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:all .2s}
.featureSectionHeader:hover{border-color:#4a5a8f}
.featureSectionTitle{font-size:1.4rem;font-weight:700;color:#cbd5e1;display:flex;align-items:center;gap:var(--sp-sm)}
.featureToggleBtn{background:transparent;border:1px solid #6b7280;color:#9aa3b2;padding:var(--sp-xs) var(--sp-md);border-radius:var(--sp-sm);font-size:1.1rem;cursor:pointer;transition:all .2s}
.featureToggleBtn:hover{border-color:#cbd5e1;color:#cbd5e1}
.featureSectionContent{margin-top:var(--sp-sm);display:none}
.featureSectionContent.show{display:block}
.playerPhotoPro{width:96px;height:96px;border-radius:var(--sp-sm);object-fit:cover;border:2px solid #3a4a6f;flex-shrink:0;background:#0b0d12}
.playerPhotoPro.empty{display:flex;align-items:center;justify-content:center;font-size:2.5rem;color:var(--muted)}
.playerDetailsPro{flex:1;display:flex;flex-direction:column;gap:var(--sp-xs);min-width:0}
.playerNamePro{font-size:1.8rem;font-weight:800;color:#e7eaf0;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.playerMetaPro{display:flex;align-items:center;gap:var(--sp-sm);font-size:1.3rem;color:#9aa3b2;flex-wrap:wrap}
.playerMetaPro .icon{margin-right:2px}
.countryNamePro{font-weight:600;color:#a9b8ff}
.chipsEditBtn{background:transparent;border:1px solid var(--acc);color:var(--acc);padding:var(--sp-xs) var(--sp-sm);border-radius:var(--sp-xs);font-size:1.1rem;cursor:pointer;font-weight:600;margin-left:auto}
.photoEditBtn{background:transparent;border:1px solid #6b7280;color:#9aa3b2;padding:var(--sp-xs) var(--sp-sm);border-radius:var(--sp-xs);font-size:1.1rem;cursor:pointer;align-self:flex-start}

/* === Loading (Unified Overlay System) === */
.error{background:#b91c1c;color:#ffe5e5;padding:var(--sp-md);border-radius:var(--sp-sm);margin-bottom:var(--sp-md);font-size:.9rem}

/* Unified Loading Overlay */
#screenLock{position:fixed;inset:0;background:rgba(11,13,18,0.95);display:none;align-items:center;justify-content:center;z-index:200;pointer-events:all;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
#screenLock.active{display:flex;animation:fadeIn 0.2s ease-out}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

.lockContent{text-align:center;color:var(--text);max-width:min(320px,90vw);padding:var(--sp-lg)}
.lockSpinner{width:56px;height:56px;border:4px solid rgba(42,111,255,0.15);border-top-color:var(--acc);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto var(--sp-md)}
@keyframes spin{to{transform:rotate(360deg)}}
.lockText{font-size:1.5rem;font-weight:600;color:var(--text);margin-bottom:var(--sp-sm)}
.lockHint{font-size:1.1rem;color:var(--muted);margin-top:var(--sp-xs)}

/* Progress Bar */
.lockProgress{width:100%;height:6px;background:rgba(42,111,255,0.15);border-radius:3px;overflow:hidden;margin:var(--sp-md) 0;display:none}
.lockProgress.show{display:block}
.lockProgressBar{height:100%;background:linear-gradient(90deg,var(--acc),#4a8fff);transition:width 0.3s ease;border-radius:3px}
.lockProgressText{font-size:1.2rem;color:var(--acc);font-weight:700;display:none}
.lockProgressText.show{display:block}

/* Cancel Button */
.lockCancel{background:transparent;border:1px solid var(--red);color:var(--red);padding:var(--sp-sm) var(--sp-lg);border-radius:var(--sp-sm);font-size:1.3rem;cursor:pointer;margin-top:var(--sp-lg);display:none;transition:all 0.2s}
.lockCancel.show{display:inline-block}
.lockCancel:active{transform:scale(0.95)}

/* Toast (Success/Error Í∞ÑÎã® ÏïåÎ¶º) */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--panel);color:var(--text);padding:var(--sp-md) var(--sp-lg);border-radius:var(--sp-md);border:1px solid var(--line);font-size:1.3rem;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:300;opacity:0;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);max-width:90vw}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.toast.success{border-color:var(--green);background:linear-gradient(135deg,var(--panel),rgba(34,197,94,0.1))}
.toast.error{border-color:var(--red);background:linear-gradient(135deg,var(--panel),rgba(239,68,68,0.1))}
.toast.warning{border-color:#f59e0b;background:linear-gradient(135deg,var(--panel),rgba(245,158,11,0.1))}
</style>
</head>
<body>
<header>
  <div><strong>üéØ Tracker</strong></div>
  <div><span class="muted small" id="keyCountHeader">Key Players (0)</span></div>
</header>

<div class="wrap">
  <!-- Key Player View -->
  <div id="viewKeyPlayers">
    <div id="keyPlayerList" class="loading">Loading...</div>
  </div>

  <!-- Table View -->
  <div id="viewTable" class="hidden">
    <button class="backBtn">‚Üê Back</button>
    <div class="panel">
      <h2 id="tableTitle">T##</h2>
      <div id="tablePlayerList"></div>
    </div>
  </div>
</div>

<!-- Overlay -->
<div id="overlay">
  <div class="overlayBox">
    <div id="overlayContent"></div>
  </div>
</div>

<!-- Unified Loading Overlay -->
<div id="screenLock">
  <div class="lockContent">
    <div class="lockSpinner"></div>
    <div class="lockText">Loading...</div>
    <div class="lockHint"></div>
    <div class="lockProgress">
      <div class="lockProgressBar" style="width:0%"></div>
    </div>
    <div class="lockProgressText">0%</div>
    <button class="lockCancel">Cancel</button>
  </div>
</div>

<!-- Firebase Proxy Mode (Phase 3.5.1 - Secure) -->
<script>
/* ===== Firebase Configuration ===== */
// üîí Î≥¥Ïïà: Apps Script ProxyÎ•º ÌÜµÌï¥ Firebase Îç∞Ïù¥ÌÑ∞ Î°úÎìú
// API KeyÎ•º Î∏åÎùºÏö∞Ï†ÄÏóê ÎÖ∏Ï∂úÌïòÏßÄ ÏïäÏùå

// Firebase Ï∫êÏã± Î™®Îìú ÌôúÏÑ±Ìôî
const ENABLE_FIREBASE_CACHE = true; // ‚úÖ Firebase Ï∫êÏãú ÏÇ¨Ïö© (Apps Script Proxy)

// Ìè¥ÎßÅ Í∞ÑÍ≤© (Î∞ÄÎ¶¨Ï¥à)
const FIREBASE_POLLING_INTERVAL = 5000; // 5Ï¥àÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏ ÌôïÏù∏

if (ENABLE_FIREBASE_CACHE) {
  console.log('üî• Firebase Proxy Î™®Îìú ÌôúÏÑ±Ìôî (Î≥¥Ïïà)');

  // Ìè¥ÎßÅ Ìï®Ïàò
  let isPolling = false;

  function pollFirebaseData() {
    if (isPolling) return;
    isPolling = true;

    google.script.run
      .withSuccessHandler(response => {
        isPolling = false;

        if (!response.success) {
          console.warn('‚ö†Ô∏è Firebase Ï°∞Ìöå Ïã§Ìå®, Sheets Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©');
          return;
        }

        const players = response.data.players;

        console.log('‚úÖ Firebase Îç∞Ïù¥ÌÑ∞ ÏàòÏã† (Proxy):', players.length, ' players');

        // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ÏôÄ ÎπÑÍµê (Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÏûàÏùÑ ÎïåÎßå Î†åÎçîÎßÅ)
        const currentHash = JSON.stringify(keyPlayers);
        const newHash = JSON.stringify(players);

        if (currentHash !== newHash) {
          console.log('üîÑ Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω Í∞êÏßÄ, Î†åÎçîÎßÅ ÏóÖÎç∞Ïù¥Ìä∏');
          keyPlayers = players;
          renderKeyPlayers(players);
        }

        // ÌôîÎ©¥ Ïû†Í∏à Ìï¥Ï†ú
        unlockScreen();

        // Firebase Î™®Îìú ÌëúÏãú
        const header = document.querySelector('header > div:first-child');
        if (header && !header.textContent.includes('üî•')) {
          header.innerHTML = '<strong>üéØ Tracker</strong> <span style="color:#fbbf24;font-size:0.8rem">üî• Proxy</span>';
        }
      })
      .withFailureHandler(err => {
        isPolling = false;
        console.error('‚ùå Firebase Proxy ÏóêÎü¨:', err);
        // Fallback: Google SheetsÎ°ú Î°úÎìú
        loadKeyPlayersFromSheets();
      })
      .getKeyPlayersFromFirebase();
  }

  // Ï≤´ Î°úÎìú Î∞è Ï£ºÍ∏∞Ï†Å Ìè¥ÎßÅ
  window.addEventListener('load', () => {
    pollFirebaseData(); // Ï¶âÏãú Î°úÎìú

    // 5Ï¥àÎßàÎã§ Ìè¥ÎßÅ (Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏)
    setInterval(pollFirebaseData, FIREBASE_POLLING_INTERVAL);
  });
} else {
  console.log('üìä Google Sheets Î™®Îìú (Firebase ÎπÑÌôúÏÑ±Ìôî)');
}
</script>

<script>
/* ===== Version Management ===== */
// version.jsÏóêÏÑú Î≤ÑÏ†Ñ Ï†ïÎ≥¥ Î°úÎìú (Î∏åÎùºÏö∞Ï†Ä ÌôòÍ≤Ω)
if (typeof window.TRACKER_VERSION !== 'undefined') {
  const versionEl = document.getElementById('appVersion');
  if (versionEl && window.TRACKER_VERSION.current) {
    versionEl.textContent = ' ' + window.TRACKER_VERSION.current;
  }
}

/* ===== Helper Functions ===== */
// ÌÖåÏù¥Î∏î Î≤àÌò∏: Ïà´Ïûê ‚Üí "T15" ÌòïÏãù Î≥ÄÌôò
function formatTableNo(num) {
  return 'T' + num;
}

// Ï¢åÏÑù Î≤àÌò∏: Ïà´Ïûê ‚Üí "S3" ÌòïÏãù Î≥ÄÌôò
function formatSeatNo(num) {
  return 'S' + num;
}

// ÌÖåÏù¥Î∏î Î≤àÌò∏: "T15" ÎòêÎäî "15" ‚Üí Ïà´Ïûê Î≥ÄÌôò
function parseTableNo(str) {
  const s = String(str).toUpperCase().trim();
  if (!isNaN(s)) return parseInt(s);
  if (s.startsWith('T')) return parseInt(s.substring(1));
  return 0;
}

// Ï¢åÏÑù Î≤àÌò∏: "S3" ÎòêÎäî "3" ‚Üí Ïà´Ïûê Î≥ÄÌôò
function parseSeatNo(str) {
  const s = String(str).toUpperCase().trim();
  if (!isNaN(s)) return parseInt(s);
  if (s.startsWith('S')) return parseInt(s.substring(1));
  return 0;
}

// Íµ≠Í∞Ä ÏΩîÎìú ‚Üí Íµ≠Í∞Ä players (40Í∞úÍµ≠)
function getCountryName(code) {
  const map = {
    'KR': 'South Korea', 'US': 'USA', 'CN': 'China', 'JP': 'Japan', 'GB': 'England',
    'DE': 'Germany', 'FR': 'France', 'IT': 'Italy', 'ES': 'Spain', 'PT': 'Portugal',
    'BR': 'Brazil', 'AR': 'Argentina', 'MX': 'Mexico', 'CA': 'Canada', 'AU': 'Australia',
    'NZ': 'New Zealand', 'RU': 'Russia', 'UA': 'Ukraine', 'PL': 'Poland', 'CZ': 'Czech Republic',
    'SE': 'Sweden', 'NO': 'Norway', 'FI': 'Finland', 'DK': 'Denmark', 'NL': 'Netherlands',
    'BE': 'Belgium', 'CH': 'Switzerland', 'AT': 'Austria', 'GR': 'Greece', 'TR': 'Turkey',
    'IL': 'Israel', 'AE': 'UAE', 'IN': 'India', 'TH': 'Thailand', 'VN': 'Vietnam',
    'PH': 'Philippines', 'ID': 'Indonesia', 'MY': 'Malaysia', 'SG': 'Singapore', 'HK': 'Hong Kong'
  };
  return map[String(code).toUpperCase()] || code;
}

/* ===== State ===== */
let currentView = 'key'; // 'key' | 'table'
let currentTableId = null;
let keyPlayers = [];

/* ===== Init ===== */
window.onload = () => {
  loadKeyPlayers();

  // Back Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
  const backBtn = document.querySelector('.backBtn');
  if (backBtn) {
    backBtn.addEventListener('click', showKeyPlayerView);
  }
};

/* ===== View Switching ===== */
function showKeyPlayerView() {
  document.getElementById('viewKeyPlayers').classList.remove('hidden');
  document.getElementById('viewTable').classList.add('hidden');
  currentView = 'key';
  currentTableId = null;
}

function showTableView(tableId) {
  // Í∏∞Ï°¥ roomTableInfo Ï†úÍ±∞
  const oldInfo = document.querySelector('#viewTable .roomTableInfo');
  if (oldInfo) oldInfo.remove();

  document.getElementById('viewKeyPlayers').classList.add('hidden');
  document.getElementById('viewTable').classList.remove('hidden');
  document.getElementById('tableTitle').textContent = formatTableNo(tableId);
  currentView = 'table';
  currentTableId = tableId;
  loadTablePlayers(tableId);
}

/* ===== Key Player View ===== */
const CACHE_TTL = 5 * 60 * 1000; // 5Î∂Ñ
const CACHE_KEY = 'keyPlayers_cache_v1';
const CACHE_TIME_KEY = 'keyPlayers_cacheTime_v1';

function loadKeyPlayers() {
  // FirebaseÍ∞Ä ÌôúÏÑ±ÌôîÎêòÎ©¥ Ïù¥ Ìï®ÏàòÎäî Ìò∏Ï∂úÎêòÏßÄ ÏïäÏùå (Ïã§ÏãúÍ∞Ñ Íµ¨ÎèÖÏù¥ ÎåÄÏ≤¥)
  loadKeyPlayersWithCache();
}

/**
 * LocalStorage Ï∫êÏãúÎ•º ÌôúÏö©Ìïú Key Player Î°úÎî© (Stale-While-Revalidate)
 */
function loadKeyPlayersWithCache() {
  const cachedData = localStorage.getItem(CACHE_KEY);
  const cachedTime = localStorage.getItem(CACHE_TIME_KEY);

  if (cachedData && cachedTime) {
    const age = Date.now() - parseInt(cachedTime);
    if (age < CACHE_TTL) {
      console.log('[Cache HIT] Age:', Math.round(age / 1000) + 's');
      const players = JSON.parse(cachedData);
      keyPlayers = players;
      renderKeyPlayers(players);

      // Î∞±Í∑∏ÎùºÏö¥ÎìúÏóêÏÑú ÏµúÏã† Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå (Stale-While-Revalidate)
      fetchLatestKeyPlayers(true);
      return;
    } else {
      console.log('[Cache EXPIRED] Age:', Math.round(age / 1000) + 's');
    }
  }

  // Ï∫êÏãú ÎØ∏Ïä§: ÏÑúÎ≤ÑÏóêÏÑú Î°úÎìú (Î°úÎî© UI ÌëúÏãú)
  console.log('[Cache MISS] Fetching from server');
  loadKeyPlayersFromSheets();
}

/**
 * ÏµúÏã† Key Player Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå (Î∞±Í∑∏ÎùºÏö¥Îìú)
 * @param {boolean} silent - trueÏùº Í≤ΩÏö∞ Î°úÎî© UI ÏóÜÏù¥ Ï°∞Ïö©Ìûà ÏóÖÎç∞Ïù¥Ìä∏
 */
function fetchLatestKeyPlayers(silent = false) {
  if (!silent) {
    LoadingManager.show({
      message: 'Loading key players',
      hint: 'Please wait',
      timeout: 30000
    });
  }

  google.script.run
    .withSuccessHandler(response => {
      if (!silent) {
        LoadingManager.hide();
      }

      if (!response.success) {
        if (!silent) {
          LoadingManager.showToast('Failed to load data: ' + (response.error?.message || 'Unknown error'), 'error');
        }
        return;
      }

      const players = response.data.players;

      // Ï∫êÏãú Ï†ÄÏû•
      localStorage.setItem(CACHE_KEY, JSON.stringify(players));
      localStorage.setItem(CACHE_TIME_KEY, String(Date.now()));
      console.log('[Cache SAVED] Entries:', players.length);

      // Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω ÏãúÏóêÎßå Î†åÎçîÎßÅ (ÏÑ±Îä• ÏµúÏ†ÅÌôî)
      const currentHash = JSON.stringify(keyPlayers);
      const newHash = JSON.stringify(players);
      if (currentHash !== newHash) {
        console.log('[Data Changed] Re-rendering');
        keyPlayers = players;
        renderKeyPlayers(players);
      } else {
        console.log('[Data Same] Skip rendering');
      }
    })
    .withFailureHandler(err => {
      if (!silent) {
        LoadingManager.hide('error', 'Network error: ' + err.message);
      }
      console.error('[Fetch ERROR]', err.message);
    })
    .getKeyPlayers();
}

function loadKeyPlayersFromSheets() {
  fetchLatestKeyPlayers(false);
}

/**
 * Ï∫êÏãú Î¨¥Ìö®Ìôî (ÏÇ¨ÏßÑ/ÌÉÄÏûÖ ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ Ìò∏Ï∂ú)
 */
function invalidateKeyPlayersCache() {
  localStorage.removeItem(CACHE_KEY);
  localStorage.removeItem(CACHE_TIME_KEY);
  console.log('[Cache INVALIDATED]');
}

function renderKeyPlayers(players) {
  const list = document.getElementById('keyPlayerList');
  const countHeader = document.getElementById('keyCountHeader');

  if (players.length === 0) {
    list.innerHTML = '<div class="muted small">No key players</div>';
    countHeader.textContent = 'Key Players (0)';
    return;
  }

  list.innerHTML = '';

  // Phase 3.6.1: ÌôúÏÑ± ÌîåÎ†àÏù¥Ïñ¥ Ïàò Í≥ÑÏÇ∞ (Feature Ï†úÏô∏)
  const activeCount = players.filter(p => p.playerType !== 'Feature').length;
  countHeader.textContent = 'Key Players (' + activeCount + ')';

  // Î™®Îì† ÌîåÎ†àÏù¥Ïñ¥ Î†åÎçîÎßÅ (FeatureÎäî ÎπÑÌôúÏÑ±Ìôî ÏÉÅÌÉúÎ°ú ÏµúÌïòÎã®)
  players.forEach(p => {
    const isFeature = p.playerType === 'Feature';
    renderPlayerCard(p, list, isFeature);
  });
}

/**
 * ÌîåÎ†àÏù¥Ïñ¥ Ïπ¥Îìú Î†åÎçîÎßÅ (Í≥µÌÜµ Ìï®Ïàò)
 * @param {Object} p - ÌîåÎ†àÏù¥Ïñ¥ Îç∞Ïù¥ÌÑ∞
 * @param {HTMLElement} list - Î∂ÄÎ™® Î¶¨Ïä§Ìä∏ ÏöîÏÜå
 * @param {boolean} isFeature - Feature ÌîåÎ†àÏù¥Ïñ¥ Ïó¨Î∂Ä
 */
function renderPlayerCard(p, list, isFeature) {
    const card = document.createElement('div');
    card.className = isFeature ? 'keyPlayerCardPro feature' : 'keyPlayerCardPro';

    // Íµ≠Í∞Ä players
    const countryName = getCountryName(p.nationality);

    // Ïπ© ÏâºÌëú Ìè¨Îß∑
    const chipsFormatted = formatChips(p.chipCount);

    // Ïπ¥Îìú Íµ¨Ï°∞ ÏÉùÏÑ± (DOM API ÏÇ¨Ïö© - template literal Ï†úÍ±∞)
    const roomInfo = document.createElement('div');
    roomInfo.className = 'roomTableInfo';
    roomInfo.textContent = formatRoomTableInfo(p.pokerRoom, p.tableName, p.tableNo);

    const photoContainer = document.createElement('div');
    photoContainer.className = 'photoContainer';

    const playerDetails = document.createElement('div');
    playerDetails.className = 'playerDetailsPro';

    // Phase 3.5.2: Î≤àÌò∏ Î±ÉÏßÄ + ÌîåÎ†àÏù¥Ïñ¥ NameÏùÑ Ìï®Íªò ÌëúÏãú
    const playerName = document.createElement('div');
    playerName.className = 'playerNamePro';
    playerName.style.display = 'flex';
    playerName.style.alignItems = 'center';
    playerName.style.gap = 'var(--sp-xs)';

    // Î≤àÌò∏ Î±ÉÏßÄ (Phase 3.6.1: PlayerType ÏïÑÏù¥ÏΩò Ï∂îÍ∞Ä)
    const badge = document.createElement('span');
    badge.className = 'playerNumberBadge';

    // PlayerType ÏïÑÏù¥ÏΩò
    let typeIcon = '';
    let badgeBackground = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'; // Í∏∞Î≥∏ (Key player)

    if (p.playerType === 'Core') {
      typeIcon = 'üëë ';
      badgeBackground = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'; // Í∏àÏÉâ Í∑∏ÎùºÎîîÏñ∏Ìä∏
    } else if (p.playerType === 'Key player') {
      typeIcon = '‚≠ê ';
      badgeBackground = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'; // Î≥¥ÎùºÏÉâ Í∑∏ÎùºÎîîÏñ∏Ìä∏
    } else if (p.playerType === 'Feature') {
      typeIcon = 'üé¨ ';
      badgeBackground = 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)'; // ÌöåÏÉâ Í∑∏ÎùºÎîîÏñ∏Ìä∏
    }

    badge.textContent = typeIcon + '#' + (p.displayOrder || 0);
    badge.style.display = 'inline-block';
    badge.style.padding = '2px 8px';
    badge.style.fontSize = '0.9rem';
    badge.style.fontWeight = 'bold';
    badge.style.color = '#fff';
    badge.style.background = badgeBackground;
    badge.style.borderRadius = '12px';
    badge.style.minWidth = '32px';
    badge.style.textAlign = 'center';

    // ÌîåÎ†àÏù¥Ïñ¥ Name ÌÖçÏä§Ìä∏
    const nameText = document.createElement('span');
    nameText.textContent = p.playerName;

    playerName.appendChild(badge);
    playerName.appendChild(nameText);

    const playerMeta = document.createElement('div');
    playerMeta.className = 'playerMetaPro';

    const locationSpan = document.createElement('span');
    const locationIcon = document.createElement('span');
    locationIcon.className = 'icon';
    locationIcon.textContent = 'üìç';
    locationSpan.appendChild(locationIcon);
    // Phase 3.6.3: Í∞ÄÏÉÅ ÌÖåÏù¥Î∏î Î≤àÌò∏Îäî ÏõêÎ≥∏ Î≤àÌò∏Î°ú ÌëúÏãú
    const displayTableNo = p.originalTableNo || p.tableNo;
    locationSpan.appendChild(document.createTextNode(formatTableNo(displayTableNo) + ', ' + formatSeatNo(p.seatNo)));

    const countrySpan = document.createElement('span');
    countrySpan.className = 'countryNamePro';
    countrySpan.textContent = getFlag(p.nationality) + ' ' + countryName;

    const chipsSpan = document.createElement('span');
    const chipsIcon = document.createElement('span');
    chipsIcon.className = 'icon';
    chipsIcon.textContent = 'üí∞';
    chipsSpan.appendChild(chipsIcon);
    chipsSpan.appendChild(document.createTextNode(chipsFormatted + ' chips'));

    playerMeta.appendChild(locationSpan);
    playerMeta.appendChild(countrySpan);
    playerMeta.appendChild(chipsSpan);

    const btnContainer = document.createElement('div');
    btnContainer.style.display = 'flex';
    btnContainer.style.gap = 'var(--sp-xs)';
    btnContainer.style.marginTop = 'var(--sp-xs)';
    btnContainer.style.alignItems = 'center';

    const photoEditBtn = document.createElement('button');
    photoEditBtn.className = 'photoEditBtn';
    photoEditBtn.textContent = 'üì∑ Photo';

    const moveBtn = document.createElement('button');
    moveBtn.className = 'photoEditBtn';
    moveBtn.textContent = 'üîÄ Move';
    moveBtn.style.borderColor = '#f59e0b';
    moveBtn.style.color = '#f59e0b';

    // Introduction Ï≤¥ÌÅ¨Î∞ïÏä§ (Phase 3.5.1)
    const introLabel = document.createElement('label');
    introLabel.style.display = 'flex';
    introLabel.style.alignItems = 'center';
    introLabel.style.gap = '6px';
    introLabel.style.fontSize = '1.3rem';
    introLabel.style.color = 'var(--text)';
    introLabel.style.cursor = 'pointer';
    introLabel.style.padding = 'var(--sp-xs) var(--sp-sm)';
    introLabel.style.border = '1px solid #6b7280';
    introLabel.style.borderRadius = 'var(--sp-xs)';
    introLabel.style.background = 'transparent';

    const introCheckbox = document.createElement('input');
    introCheckbox.type = 'checkbox';
    introCheckbox.checked = p.introduction || false;
    introCheckbox.style.width = '20px';
    introCheckbox.style.height = '20px';
    introCheckbox.style.cursor = 'pointer';
    introCheckbox.style.margin = '0';
    introCheckbox.style.flexShrink = '0';

    const introText = document.createElement('span');
    introText.textContent = 'Intro';
    introText.style.userSelect = 'none';

    introLabel.appendChild(introCheckbox);
    introLabel.appendChild(introText);

    btnContainer.appendChild(photoEditBtn);
    btnContainer.appendChild(moveBtn);
    btnContainer.appendChild(introLabel);

    playerDetails.appendChild(playerName);
    playerDetails.appendChild(playerMeta);
    playerDetails.appendChild(btnContainer);

    card.appendChild(roomInfo);
    card.appendChild(photoContainer);
    card.appendChild(playerDetails);

    // Ïπ¥Îìú ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÌÖåÏù¥Î∏î Î∑∞Î°ú Move)
    card.addEventListener('click', () => showTableView(p.tableNo));

    // Photo Edit Î≤ÑÌäº Ïù¥Î≤§Ìä∏ (DOMÏúºÎ°ú ÏïàÏ†ÑÌïòÍ≤å Ïó∞Í≤∞)
    photoEditBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      editPlayerPhoto(p.playerName, p.photoUrl || '');
    });

    // Move Î≤ÑÌäº Ïù¥Î≤§Ìä∏ (movePlayerPrompt Ïû¨ÏÇ¨Ïö©)
    moveBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      movePlayerPrompt(p.tableNo, p.seatNo, p.playerName);
    });

    // Introduction Î†àÏù¥Î∏î ÌÅ¥Î¶≠ Ïãú Ïπ¥Îìú Ïù¥Î≤§Ìä∏ Ï†ÑÌåå Î∞©ÏßÄ
    introLabel.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    // Introduction Ï≤¥ÌÅ¨Î∞ïÏä§ Ïù¥Î≤§Ìä∏ (Phase 3.5.1)
    introCheckbox.addEventListener('change', (e) => {
      e.stopPropagation();
      const isChecked = e.target.checked;
      toggleIntroduction(p.playerName, isChecked);
    });

    if (p.photoUrl && p.photoUrl.trim()) {
      // Imgur URLÏùÑ ÏßÅÏ†ë Ïù¥ÎØ∏ÏßÄ ÎßÅÌÅ¨Î°ú ÏûêÎèô Î≥ÄÌôò
      const directImageUrl = convertToDirectImageUrl(p.photoUrl);

      // img ÏöîÏÜå ÏÉùÏÑ±
      const img = document.createElement('img');
      img.src = directImageUrl;
      img.className = 'playerPhotoPro';
      img.alt = p.playerName;
      img.crossOrigin = 'anonymous';
      img.loading = 'lazy';

      img.onerror = function() {
        console.error('Image load failed:', this.src);
        this.style.display = 'none';
        if (this.nextElementSibling) this.nextElementSibling.style.display = 'flex';
      };

      img.onload = function() {
        console.log('Image loaded:', this.src);
        this.style.display = 'block';
        if (this.nextElementSibling) this.nextElementSibling.style.display = 'none';
      };

      // fallback div ÏÉùÏÑ±
      const fallback = document.createElement('div');
      fallback.className = 'playerPhotoPro empty';
      fallback.style.display = 'none';
      fallback.title = 'Image load failed';
      fallback.textContent = 'üë§';

      photoContainer.appendChild(img);
      photoContainer.appendChild(fallback);
    } else {
      // URLÏù¥ ÏóÜÏùÑ Îïå: Í∏∞Î≥∏ ÏïÑÏù¥ÏΩò
      const emptyPhoto = document.createElement('div');
      emptyPhoto.className = 'playerPhotoPro empty';
      emptyPhoto.title = 'No photo URL (Check Type sheet column N)';
      emptyPhoto.textContent = 'üë§';
      photoContainer.appendChild(emptyPhoto);
    }

    list.appendChild(card);
}

/**
 * Feature ÏÑπÏÖò Î†åÎçîÎßÅ (Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞)
 * @param {Array} featurePlayers - Feature ÌîåÎ†àÏù¥Ïñ¥ Î∞∞Ïó¥
 * @param {HTMLElement} list - Î∂ÄÎ™® Î¶¨Ïä§Ìä∏ ÏöîÏÜå
 */
function renderFeatureSection(featurePlayers, list) {
  const section = document.createElement('div');
  section.className = 'featureSection';

  const header = document.createElement('div');
  header.className = 'featureSectionHeader';

  const title = document.createElement('div');
  title.className = 'featureSectionTitle';
  title.textContent = 'üé¨ Feature Table (' + featurePlayers.length + ' players) - Monitoring Off';

  const toggleBtn = document.createElement('button');
  toggleBtn.className = 'featureToggleBtn';
  toggleBtn.textContent = '‚ñº Show';

  header.appendChild(title);
  header.appendChild(toggleBtn);

  const content = document.createElement('div');
  content.className = 'featureSectionContent';

  // Feature ÌîåÎ†àÏù¥Ïñ¥ Ïπ¥Îìú Î†åÎçîÎßÅ
  featurePlayers.forEach(p => {
    renderPlayerCard(p, content, true);
  });

  // ÌÜ†Í∏Ä Ïù¥Î≤§Ìä∏
  header.addEventListener('click', () => {
    content.classList.toggle('show');
    if (content.classList.contains('show')) {
      toggleBtn.textContent = '‚ñ≤ Hide';
    } else {
      toggleBtn.textContent = '‚ñº Show';
    }
  });

  section.appendChild(header);
  section.appendChild(content);
  list.appendChild(section);
}

/* ===== Table View ===== */
function loadTablePlayers(tableId) {
  const list = document.getElementById('tablePlayerList');

  // Î°úÎî© ÌëúÏãú (Îã®Ïùº Ïò§Î≤ÑÎ†àÏù¥)
  LoadingManager.show({
    message: 'Loading table ' + formatTableNo(tableId),
    timeout: 30000
  });

  google.script.run
    .withSuccessHandler(response => {
      if (!response.success) {
        LoadingManager.hide('error', 'Failed to load data: ' + (response.error?.message || 'Unknown error'));
        return;
      }

      const players = response.data.players;
      renderTablePlayers(tableId, players);
      LoadingManager.hide(); // Î†åÎçîÎßÅ ÏôÑÎ£å ÌõÑ Ïà®ÍπÄ (ÌÜ†Ïä§Ìä∏ ÏóÜÏùå)
    })
    .withFailureHandler(err => {
      LoadingManager.hide('error', 'Network error: ' + err.message);
    })
    .getTablePlayers(tableId);
}

function renderTablePlayers(tableId, players) {
  const list = document.getElementById('tablePlayerList');
  list.innerHTML = '';

  // tableTitle h2 ÏïûÏóê roomTableInfo div ÏÇΩÏûÖ
  const titleElement = document.getElementById('tableTitle');
  let roomInfo = document.querySelector('#viewTable .roomTableInfo');
  if (!roomInfo) {
    roomInfo = document.createElement('div');
    roomInfo.className = 'roomTableInfo';
    titleElement.parentNode.insertBefore(roomInfo, titleElement);
  }
  roomInfo.textContent = formatRoomTableInfo(players[0]?.pokerRoom, players[0]?.tableName, tableId);

  players.forEach(p => {
    const row = document.createElement('div');
    row.className = p.keyplayer ? 'playerRow keyplayer' : 'playerRow';

    if (p.empty) {
      const seat = document.createElement('span');
      seat.className = 'seat';
      seat.textContent = formatSeatNo(p.seatNo);

      const emptySeat = document.createElement('span');
      emptySeat.className = 'emptySeat';
      emptySeat.textContent = '(Empty seat)';

      const addBtn = document.createElement('button');
      addBtn.className = 'addBtn';
      addBtn.textContent = '[+]';
      addBtn.addEventListener('click', () => addPlayerPrompt(tableId, p.seatNo));

      row.appendChild(seat);
      row.appendChild(emptySeat);
      row.appendChild(addBtn);

    } else {
      const seat = document.createElement('span');
      seat.className = 'seat';
      seat.textContent = formatSeatNo(p.seatNo);

      const name = document.createElement('span');
      name.className = 'name';
      name.textContent = p.playerName;
      if (p.keyplayer) {
        const keyStar = document.createElement('span');
        keyStar.className = 'keyStar';
        keyStar.textContent = '‚≠ê';
        name.appendChild(keyStar);
      }

      const flag = document.createElement('span');
      flag.className = 'flag';
      flag.textContent = getFlag(p.nationality);

      const chips = document.createElement('span');
      chips.className = 'chips';
      chips.textContent = formatChips(p.chipCount);
      chips.style.cursor = 'pointer';
      chips.addEventListener('click', () => {
        editChips(tableId, p.seatNo, p.chipCount, p.playerName);
      });

      const moveBtn = document.createElement('button');
      moveBtn.className = 'moveBtn';
      moveBtn.textContent = 'üîÄ';
      moveBtn.title = 'Move player';
      moveBtn.addEventListener('click', () => {
        movePlayerPrompt(tableId, p.seatNo, p.playerName);
      });

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'deleteBtn';
      deleteBtn.textContent = 'üóëÔ∏è';
      deleteBtn.addEventListener('click', () => {
        deletePlayerConfirm(tableId, p.seatNo, p.playerName);
      });

      row.appendChild(seat);
      row.appendChild(name);
      row.appendChild(flag);
      row.appendChild(chips);
      row.appendChild(moveBtn);
      row.appendChild(deleteBtn);
    }

    list.appendChild(row);
  });
}

/* ===== Edit Chips ===== */
function editChips(tableId, seatNo, currentChips, playerName) {
  const overlay = document.getElementById('overlay');
  const content = document.getElementById('overlayContent');

  content.innerHTML = '';

  const title = document.createElement('div');
  title.className = 'overlayTitle';
  title.textContent = formatSeatNo(seatNo) + ' ' + playerName + ' Edit Chips';

  const currentInfo = document.createElement('div');
  currentInfo.className = 'muted';
  currentInfo.style.fontSize = '1.2rem';
  currentInfo.style.marginBottom = 'var(--sp-md)';
  currentInfo.textContent = 'Current: ' + formatChips(currentChips);

  const input = document.createElement('input');
  input.type = 'text';
  input.id = 'chipInput';
  input.className = 'overlayInput';
  input.placeholder = 'e.g. 750000 or 750k';
  input.autocomplete = 'off';
  input.inputMode = 'decimal';

  const actions = document.createElement('div');
  actions.className = 'overlayActions';

  const btnCancel = document.createElement('button');
  btnCancel.className = 'btnCancel';
  btnCancel.textContent = 'Cancel';
  btnCancel.addEventListener('click', closeOverlay);

  const btnConfirm = document.createElement('button');
  btnConfirm.className = 'btnConfirm';
  btnConfirm.textContent = 'Confirm';
  btnConfirm.addEventListener('click', () => confirmEditChips(tableId, seatNo, currentChips));

  actions.appendChild(btnCancel);
  actions.appendChild(btnConfirm);

  content.appendChild(title);
  content.appendChild(currentInfo);
  content.appendChild(input);
  content.appendChild(actions);

  overlay.classList.add('show');
  setTimeout(() => document.getElementById('chipInput').focus(), 100);
}

function confirmEditChips(tableId, seatNo, oldChips) {
  const input = document.getElementById('chipInput').value.trim();
  if (!input) {
    LoadingManager.showToast('Enter chip amount', 'warning');
    return;
  }

  const newChips = parseChips(input);
  if (newChips === null || newChips < 0) {
    LoadingManager.showToast('Please enter a valid number (e.g. 750k)', 'warning');
    return;
  }

  closeOverlay();

  // Ïû¨ÏÇ¨Ïö© Ìó¨Ìçº Ìï®Ïàò ÏÇ¨Ïö©
  callServerWithLoading({
    action: 'updatePlayerChips',
    params: [tableId, seatNo, newChips],
    loadingMessage: 'Updating chips',
    successMessage: '‚úÖ Chips updated successfully',
    onSuccess: () => saveChipHistory(tableId, seatNo, newChips)
  });
}

/* ===== Add Player ===== */
function addPlayerPrompt(tableId, seatNo) {
  const overlay = document.getElementById('overlay');
  const content = document.getElementById('overlayContent');

  content.innerHTML = '';

  const title = document.createElement('div');
  title.className = 'overlayTitle';
  title.textContent = seatNo + ' Add Player';

  const nameInput = document.createElement('input');
  nameInput.type = 'text';
  nameInput.id = 'nameInput';
  nameInput.className = 'overlayInput';
  nameInput.placeholder = 'Name';
  nameInput.autocomplete = 'off';

  const nationInput = document.createElement('input');
  nationInput.type = 'text';
  nationInput.id = 'nationInput';
  nationInput.className = 'overlayInput';
  nationInput.placeholder = 'Country Code (e.g. KR, US, JP)';
  nationInput.autocomplete = 'off';
  nationInput.maxLength = 2;
  nationInput.style.textTransform = 'uppercase';

  const chipsInput = document.createElement('input');
  chipsInput.type = 'text';
  chipsInput.id = 'chipsInput';
  chipsInput.className = 'overlayInput';
  chipsInput.placeholder = 'Chips (e.g. 280000 or 280k)';
  chipsInput.autocomplete = 'off';
  chipsInput.inputMode = 'decimal';

  const label = document.createElement('label');
  label.style.display = 'flex';
  label.style.alignItems = 'center';
  label.style.gap = 'var(--sp-md)';
  label.style.marginBottom = 'var(--sp-md)';

  const keyInput = document.createElement('input');
  keyInput.type = 'checkbox';
  keyInput.id = 'keyInput';
  keyInput.style.width = '32px';
  keyInput.style.height = '32px';
  keyInput.style.cursor = 'pointer';

  const labelText = document.createElement('span');
  labelText.style.fontSize = '1.4rem';
  labelText.textContent = 'Register as Key Player';

  label.appendChild(keyInput);
  label.appendChild(labelText);

  const actions = document.createElement('div');
  actions.className = 'overlayActions';

  const btnCancel = document.createElement('button');
  btnCancel.className = 'btnCancel';
  btnCancel.textContent = 'Cancel';
  btnCancel.addEventListener('click', closeOverlay);

  const btnConfirm = document.createElement('button');
  btnConfirm.className = 'btnConfirm';
  btnConfirm.textContent = 'Add';
  btnConfirm.addEventListener('click', () => confirmAddPlayer(tableId, seatNo));

  actions.appendChild(btnCancel);
  actions.appendChild(btnConfirm);

  content.appendChild(title);
  content.appendChild(nameInput);
  content.appendChild(nationInput);
  content.appendChild(chipsInput);
  content.appendChild(label);
  content.appendChild(actions);

  overlay.classList.add('show');
  setTimeout(() => document.getElementById('nameInput').focus(), 100);
}

function confirmAddPlayer(tableId, seatNo) {
  const name = document.getElementById('nameInput').value.trim();
  const nation = document.getElementById('nationInput').value.trim().toUpperCase();
  const chipsInput = document.getElementById('chipsInput').value.trim();
  const isKey = document.getElementById('keyInput').checked;

  // ÏûÖÎ†• Í≤ÄÏ¶ù (ToastÎ°ú Î≥ÄÍ≤Ω)
  if (!name) {
    LoadingManager.showToast('Please enter name', 'warning');
    return;
  }
  if (!nation) {
    LoadingManager.showToast('Please enter country code', 'warning');
    return;
  }
  if (!chipsInput) {
    LoadingManager.showToast('Enter chip amount', 'warning');
    return;
  }

  const chips = parseChips(chipsInput);
  if (chips === null || chips < 0) {
    LoadingManager.showToast('Please enter valid chip amount', 'warning');
    return;
  }

  closeOverlay();

  // Ïû¨ÏÇ¨Ïö© Ìó¨Ìçº Ìï®Ïàò ÏÇ¨Ïö©
  callServerWithLoading({
    action: 'addPlayer',
    params: [tableId, seatNo, name, nation, chips, isKey],
    loadingMessage: 'Adding player',
    successMessage: '‚úÖ ' + name + ' has been added'
  });
}

/* ===== Delete Player ===== */
function deletePlayerConfirm(tableId, seatNo, playerName) {
  if (!confirm(seatNo + ' ' + playerName + ' Delete this player?')) return;

  // Ïû¨ÏÇ¨Ïö© Ìó¨Ìçº Ìï®Ïàò ÏÇ¨Ïö©
  callServerWithLoading({
    action: 'removePlayer',
    params: [tableId, seatNo],
    loadingMessage: playerName + ' Deleting',
    successMessage: '‚úÖ ' + playerName + ' has been deleted'
  });
}

/* ===== Move Player (Phase 3.3) ===== */
function movePlayerPrompt(tableId, seatNo, playerName) {
  console.log('üîÄ movePlayerPrompt Ìò∏Ï∂ú:', { tableId, seatNo, playerName });

  const overlay = document.getElementById('overlay');
  const content = document.getElementById('overlayContent');

  if (!overlay || !content) {
    console.error('‚ùå Ïò§Î≤ÑÎ†àÏù¥ ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
    alert('Overlay element not found. Please refresh the page.');
    return;
  }

  content.innerHTML = '';

  const title = document.createElement('div');
  title.className = 'overlayTitle';
  title.textContent = 'üîÄ ' + playerName + ' Move';

  const currentInfo = document.createElement('div');
  currentInfo.style.fontSize = '1.2rem';
  currentInfo.style.color = 'var(--muted)';
  currentInfo.style.marginBottom = 'var(--sp-lg)';
  currentInfo.textContent = 'Current: T' + tableId + ' S' + seatNo;

  const labelTable = document.createElement('label');
  labelTable.htmlFor = 'moveToTable';
  labelTable.textContent = 'Destination Table Number';
  labelTable.style.display = 'block';
  labelTable.style.marginBottom = 'var(--sp-xs)';
  labelTable.style.fontSize = '1.4rem';
  labelTable.style.fontWeight = '600';

  const inputTable = document.createElement('input');
  inputTable.type = 'number';
  inputTable.id = 'moveToTable';
  inputTable.className = 'overlayInput';
  inputTable.placeholder = 'e.g. 15';
  inputTable.min = '1';
  inputTable.max = '999';
  inputTable.value = tableId; // Í∏∞Î≥∏Í∞í: ÌòÑÏû¨ ÌÖåÏù¥Î∏î

  const labelSeat = document.createElement('label');
  labelSeat.htmlFor = 'moveToSeat';
  labelSeat.textContent = 'Destination Seat Number';
  labelSeat.style.display = 'block';
  labelSeat.style.marginTop = 'var(--sp-md)';
  labelSeat.style.marginBottom = 'var(--sp-xs)';
  labelSeat.style.fontSize = '1.4rem';
  labelSeat.style.fontWeight = '600';

  const inputSeat = document.createElement('input');
  inputSeat.type = 'number';
  inputSeat.id = 'moveToSeat';
  inputSeat.className = 'overlayInput';
  inputSeat.placeholder = 'e.g. 3';
  inputSeat.min = '1';
  inputSeat.max = '9';

  const warningText = document.createElement('div');
  warningText.style.fontSize = '1.2rem';
  warningText.style.color = '#f59e0b';
  warningText.style.marginTop = 'var(--sp-md)';
  warningText.style.marginBottom = 'var(--sp-md)';
  warningText.textContent = '‚ö†Ô∏è Destination will overwrite existing player if present.';

  const actions = document.createElement('div');
  actions.className = 'overlayActions';

  const btnCancel = document.createElement('button');
  btnCancel.className = 'btnCancel';
  btnCancel.textContent = 'Cancel';
  btnCancel.onclick = closeOverlay;

  const btnConfirm = document.createElement('button');
  btnConfirm.className = 'btnConfirm';
  btnConfirm.textContent = 'Move';
  btnConfirm.onclick = () => confirmMovePlayer(tableId, seatNo, playerName);

  actions.appendChild(btnCancel);
  actions.appendChild(btnConfirm);

  content.appendChild(title);
  content.appendChild(currentInfo);
  content.appendChild(labelTable);
  content.appendChild(inputTable);
  content.appendChild(labelSeat);
  content.appendChild(inputSeat);
  content.appendChild(warningText);
  content.appendChild(actions);

  overlay.classList.add('show');
  console.log('‚úÖ Ïò§Î≤ÑÎ†àÏù¥ ÌëúÏãú ÏôÑÎ£å');
  setTimeout(() => inputTable.focus(), 100);
}

function confirmMovePlayer(fromTableNo, fromSeatNo, playerName) {
  console.log('üîÄ confirmMovePlayer Ìò∏Ï∂ú:', { fromTableNo, fromSeatNo, playerName });

  const toTableNo = parseInt(document.getElementById('moveToTable').value);
  const toSeatNo = parseInt(document.getElementById('moveToSeat').value);

  console.log('üìç Î™©Ï†ÅÏßÄ:', { toTableNo, toSeatNo });

  // ÏûÖÎ†• Í≤ÄÏ¶ù (ToastÎ°ú Î≥ÄÍ≤Ω)
  if (!toTableNo || toTableNo < 1) {
    LoadingManager.showToast('Please enter destination table number', 'warning');
    return;
  }

  if (!toSeatNo || toSeatNo < 1 || toSeatNo > 9) {
    LoadingManager.showToast('Please enter destination seat number (1-9)', 'warning');
    return;
  }

  if (fromTableNo === toTableNo && fromSeatNo === toSeatNo) {
    LoadingManager.showToast('Source and destination are the same', 'warning');
    return;
  }

  closeOverlay();

  // Move ÏûëÏóÖ Ï†ÑÏ≤¥ ÎèôÏïà Î°úÎî© Ïú†ÏßÄ
  console.log('‚è≥ [1/4] Î°úÎî© ÏãúÏûë');
  LoadingManager.show({
    message: 'Moving ' + playerName + '...',
    hint: 'T' + fromTableNo + ' S' + fromSeatNo + ' ‚Üí T' + toTableNo + ' S' + toSeatNo,
    timeout: 30000
  });

  console.log('üì° [2/4] ÏÑúÎ≤Ñ Ìï®Ïàò Ìò∏Ï∂ú: movePlayer');
  google.script.run
    .withSuccessHandler(response => {
      if (!response.success) {
        console.log('‚ùå [X] ÏÑúÎ≤Ñ ÏóêÎü¨:', response.error?.message);
        LoadingManager.hide('error', 'Error: ' + (response.error?.message || 'Move failed'));
        return;
      }

      console.log('‚úÖ [3/4] ÏÑúÎ≤Ñ ÏûëÏóÖ ÏôÑÎ£å, ÌôîÎ©¥ ÏÉàÎ°úÍ≥†Ïπ® ÏãúÏûë');
      LoadingManager.show({
        message: 'Refreshing screen...',
        hint: 'Loading latest data'
      });

      // ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å ÌõÑ Î°úÎî© Ïà®ÍπÄ
      const refreshCompleted = () => {
        console.log('üéâ [4/4] Ï†ÑÏ≤¥ ÏûëÏóÖ ÏôÑÎ£å');
        LoadingManager.hide('success', '‚úÖ ' + playerName + ' moved to T' + toTableNo + ' S' + toSeatNo);
      };

      if (currentView === 'key') {
        loadKeyPlayers();
        setTimeout(refreshCompleted, 500); // Î†åÎçîÎßÅ ÎåÄÍ∏∞
      } else {
        loadTablePlayers(currentTableId);
        setTimeout(refreshCompleted, 500); // Î†åÎçîÎßÅ ÎåÄÍ∏∞
      }
    })
    .withFailureHandler(err => {
      console.log('‚ùå [X] ÎÑ§Ìä∏ÏõåÌÅ¨ ÏóêÎü¨:', err.message);
      LoadingManager.hide('error', 'Network error: ' + err.message);
    })
    .movePlayer(fromTableNo, fromSeatNo, toTableNo, toSeatNo);
}

/* ===== Player Photo Edit (Phase 3.1) ===== */
function editPlayerPhoto(playerName, currentPhotoUrl) {
  const overlay = document.getElementById('overlay');
  const content = document.getElementById('overlayContent');

  content.innerHTML = '';

  const title = document.createElement('div');
  title.className = 'overlayTitle';
  title.textContent = 'üì∑ ' + playerName + ' Photo Edit';

  const input = document.createElement('input');
  input.type = 'text';
  input.id = 'photoUrlInput';
  input.className = 'overlayInput';
  input.placeholder = 'https://i.imgur.com/abc123.jpg';
  input.value = currentPhotoUrl;

  // Phase 3.2: Take Photo Î≤ÑÌäº Add
  const photoTakeBtn = document.createElement('button');
  photoTakeBtn.className = 'btnTakePhoto';
  photoTakeBtn.textContent = 'üì∑ Take Photo';
  photoTakeBtn.style.width = '100%';
  photoTakeBtn.style.background = '#16a34a';
  photoTakeBtn.style.border = '1px solid #16a34a';
  photoTakeBtn.style.color = '#fff';
  photoTakeBtn.style.borderRadius = 'var(--sp-sm)';
  photoTakeBtn.style.padding = 'var(--sp-lg)';
  photoTakeBtn.style.fontSize = '1.4rem';
  photoTakeBtn.style.cursor = 'pointer';
  photoTakeBtn.style.fontWeight = '700';
  photoTakeBtn.style.marginBottom = 'var(--sp-md)';
  photoTakeBtn.style.minHeight = '56px';

  const photoFileInput = document.createElement('input');
  photoFileInput.type = 'file';
  photoFileInput.accept = 'image/*';
  photoFileInput.capture = 'environment'; // ÌõÑÎ©¥ Ïπ¥Î©îÎùº
  photoFileInput.style.display = 'none';

  photoTakeBtn.addEventListener('click', () => {
    photoFileInput.click();
  });

  photoFileInput.addEventListener('change', (e) => {
    handlePhotoCapture(e, playerName);
  });

  const hint = document.createElement('div');
  hint.style.fontSize = '1.1rem';
  hint.style.color = '#9aa3b2';
  hint.style.marginTop = '-8px';
  hint.style.marginBottom = '12px';
  hint.textContent = 'Or enter URL directly:';

  const actions = document.createElement('div');
  actions.className = 'overlayActions';

  const btnCancel = document.createElement('button');
  btnCancel.className = 'btnCancel';
  btnCancel.textContent = 'Cancel';
  btnCancel.addEventListener('click', closeOverlay);

  const btnConfirm = document.createElement('button');
  btnConfirm.className = 'btnConfirm';
  btnConfirm.textContent = 'Save';
  btnConfirm.addEventListener('click', () => confirmPhotoEdit(playerName));

  actions.appendChild(btnCancel);
  actions.appendChild(btnConfirm);

  content.appendChild(title);
  content.appendChild(photoTakeBtn);
  content.appendChild(photoFileInput);
  content.appendChild(hint);
  content.appendChild(input);
  content.appendChild(actions);

  overlay.classList.add('show');

  // Ìè¨Ïª§Ïä§
  setTimeout(() => {
    const input = document.getElementById('photoUrlInput');
    if (input) input.focus();
  }, 100);
}

function confirmPhotoEdit(playerName) {
  const input = document.getElementById('photoUrlInput');
  let photoUrl = input.value.trim();

  // ÏûÖÎ†• Í≤ÄÏ¶ù (ToastÎ°ú Î≥ÄÍ≤Ω)
  if (!photoUrl) {
    LoadingManager.showToast('Please enter photo URL', 'warning');
    return;
  }

  if (!photoUrl.startsWith('https://') && !photoUrl.startsWith('http://')) {
    LoadingManager.showToast('Please enter URL starting with HTTP(S)', 'warning');
    return;
  }

  // Imgur URL ÏûêÎèô Î≥ÄÌôò Î∞è ÏÇ¨Ïö©Ïûê ÏïàÎÇ¥
  const directUrl = convertToDirectImageUrl(photoUrl);
  if (directUrl !== photoUrl) {
    const confirmed = confirm(
      'Imgur page URL detected.\n\n' +
      'Original: ' + photoUrl + '\n' +
      'Converted: ' + directUrl + '\n\n' +
      'Convert to direct image link and save?'
    );
    if (confirmed) {
      photoUrl = directUrl;
    }
  }

  closeOverlay();

  // Ïû¨ÏÇ¨Ïö© Ìó¨Ìçº Ìï®Ïàò ÏÇ¨Ïö©
  callServerWithLoading({
    action: 'updateKeyPlayerPhoto',
    params: [playerName, photoUrl],
    loadingMessage: 'Saving photo URL',
    successMessage: '‚úÖ Photo saved successfully',
    onSuccess: () => {
      // Ï∫êÏãú Î¨¥Ìö®Ìôî (Ï¶âÏãú Î∞òÏòÅ)
      invalidateKeyPlayersCache();
    }
  });
}

/* ===== Utilities ===== */
/**
 * Imgur URLÏùÑ ÏßÅÏ†ë Ïù¥ÎØ∏ÏßÄ ÎßÅÌÅ¨Î°ú Î≥ÄÌôò
 * @param {string} url - ÏõêÎ≥∏ URL
 * @return {string} Î≥ÄÌôòÎêú URL
 */
function convertToDirectImageUrl(url) {
  if (!url || !url.trim()) return '';

  const trimmedUrl = url.trim();

  // Ïù¥ÎØ∏ ÏßÅÏ†ë Ïù¥ÎØ∏ÏßÄ ÎßÅÌÅ¨Î©¥ Í∑∏ÎåÄÎ°ú Î∞òÌôò
  if (trimmedUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
    return trimmedUrl;
  }

  // Imgur ÌéòÏù¥ÏßÄ URL ‚Üí ÏßÅÏ†ë Ïù¥ÎØ∏ÏßÄ ÎßÅÌÅ¨ Î≥ÄÌôò
  // https://imgur.com/abc123 ‚Üí https://i.imgur.com/abc123.jpg
  const imgurMatch = trimmedUrl.match(/^https?:\/\/imgur\.com\/([a-zA-Z0-9]+)$/);
  if (imgurMatch) {
    const imageId = imgurMatch[1];
    const convertedUrl = 'https://i.imgur.com/' + imageId + '.jpg';
    console.log('Imgur URL Converted: ' + trimmedUrl + ' ‚Üí ' + convertedUrl);
    return convertedUrl;
  }

  // Í∏∞ÌÉÄ URLÏùÄ Í∑∏ÎåÄÎ°ú Î∞òÌôò
  return trimmedUrl;
}

/**
 * Poker Room, Table Name, Table NoÎ•º Ìè¨Îß∑ÌåÖ
 * @param {string} pokerRoom - Poker Room Name
 * @param {string} tableName - Table Name
 * @param {string} tableId - Table No (Ïòà: T1)
 * @return {string} "Merit Hall | Ocean Blue | T1" ÌòïÏãù
 */
function formatRoomTableInfo(pokerRoom, tableName, tableId) {
  const room = pokerRoom || '';
  const table = tableName || '';
  return room + ' | ' + table + ' | ' + tableId;
}

function parseChips(input) {
  if (!input) return null;
  const str = String(input).trim().toLowerCase();
  if (str.endsWith('k')) {
    const num = parseFloat(str.slice(0, -1));
    return isNaN(num) ? null : Math.round(num * 1000);
  }
  const num = parseFloat(str.replace(/[^\d.]/g, ''));
  return isNaN(num) ? null : Math.round(num);
}

function formatChips(chips) {
  if (chips >= 1000) {
    return Math.round(chips / 1000) + 'k';
  }
  return chips.toString();
}

function getFlag(nationCode) {
  const flags = {
    'KR': 'üá∞üá∑', 'US': 'üá∫üá∏', 'JP': 'üáØüáµ', 'CN': 'üá®üá≥', 'GB': 'üá¨üáß',
    'FR': 'üá´üá∑', 'DE': 'üá©üá™', 'CA': 'üá®üá¶', 'AU': 'üá¶üá∫', 'TW': 'üáπüáº'
  };
  return flags[nationCode] || 'üåê';
}

function getChipChange(tableId, seatNo, currentChips) {
  const key = tableId + '_' + seatNo;
  const history = JSON.parse(localStorage.getItem('phl_chipHistory') || '{}');
  const oldChips = history[key] || currentChips;

  const diff = currentChips - oldChips;
  if (diff > 0) {
    return { amount: diff, direction: 'up', text: '‚Üë' + formatChips(diff) };
  } else if (diff < 0) {
    return { amount: diff, direction: 'down', text: '‚Üì' + formatChips(Math.abs(diff)) };
  } else {
    return { amount: 0, direction: 'same', text: '' };
  }
}

function saveChipHistory(tableId, seatNo, chips) {
  const key = tableId + '_' + seatNo;
  const history = JSON.parse(localStorage.getItem('phl_chipHistory') || '{}');
  history[key] = chips;
  localStorage.setItem('phl_chipHistory', JSON.stringify(history));
}

/* ===== Photo Capture Handler (Phase 3.2) ===== */
let isUploading = false; // Ï§ëÎ≥µ ÏóÖÎ°úÎìú Î∞©ÏßÄ

/**
 * Take Photo ÌõÑ Imgur ÏóÖÎ°úÎìú Ï≤òÎ¶¨
 * @param {Event} e - File input change event
 * @param {string} playerName - ÌîåÎ†àÏù¥Ïñ¥ Name
 */
function handlePhotoCapture(e, playerName) {
  const file = e.target.files[0];
  if (!file) return;

  // Ï§ëÎ≥µ ÏóÖÎ°úÎìú Î∞©ÏßÄ
  if (isUploading) {
    alert('Upload already in progress. Please wait.');
    return;
  }

  // ÌååÏùº ÌÉÄÏûÖ Í≤ÄÏ¶ù
  if (!file.type.startsWith('image/')) {
    alert('Only image files can be uploaded.');
    return;
  }

  // ÌååÏùº ÌÅ¨Í∏∞ Ï†úÌïú (5MB)
  const MAX_SIZE = 5 * 1024 * 1024;
  if (file.size > MAX_SIZE) {
    alert('Photo size must be 5MB or less.\nCurrent: ' + Math.round(file.size / 1024 / 1024) + 'MB');
    return;
  }

  isUploading = true;

  // ÌåùÏóÖ Îã´Í≥† Î°úÎî© ÌôîÎ©¥ ÌëúÏãú (ÏßÑÌñâÎ•† Î∞î + Cancel Î≤ÑÌäº)
  closeOverlay();
  LoadingManager.show({
    message: 'Uploading photo',
    hint: 'May take time depending on network status',
    progress: true,
    cancelable: true,
    timeout: 60000,
    onCancel: () => {
      isUploading = false;
      LoadingManager.showToast('Photo upload cancelled', 'warning');
    }
  });

  const reader = new FileReader();
  reader.onload = function() {
    const base64 = reader.result.split(',')[1];

    // ÏßÑÌñâÎ•† ÏãúÎÆ¨Î†àÏù¥ÏÖò (Imgur APIÎäî Ïã§Ï†ú ÏßÑÌñâÎ•† ÎØ∏Ï†úÍ≥µ)
    let progress = 0;
    const progressInterval = setInterval(() => {
      progress += 8;
      if (progress <= 80) {
        LoadingManager.setProgress(progress);
      }
    }, 500);

    google.script.run
      .withSuccessHandler(response => {
        clearInterval(progressInterval);
        isUploading = false;

        if (response.success) {
          LoadingManager.setProgress(100);

          // ÏûêÎèô Save
          google.script.run
            .withSuccessHandler(saveResponse => {
              if (saveResponse.success) {
                LoadingManager.hide('success', '‚úÖ Photo saved successfully');
                invalidateKeyPlayersCache(); // Ï∫êÏãú Î¨¥Ìö®Ìôî
                loadKeyPlayers();
              } else {
                LoadingManager.hide('error', 'Save failed: ' + (saveResponse.error?.message || 'Unknown error'));
              }
            })
            .withFailureHandler(err => {
              LoadingManager.hide('error', 'Save Error: ' + err.message);
            })
            .updateKeyPlayerPhoto(playerName, response.data.imgurUrl);
        } else {
          LoadingManager.hide('error', 'Upload failed: ' + (response.error?.message || 'Unknown error'));
        }
      })
      .withFailureHandler(err => {
        clearInterval(progressInterval);
        isUploading = false;

        // ÏóêÎü¨ ÌÉÄÏûÖ Î∂ÑÏÑù
        let errorMsg = 'Upload error: ' + err.message;
        if (err.message.includes('429')) {
          errorMsg = 'Imgur upload limit exceeded. Try again in 1 minute.';
        } else if (err.message.includes('timeout')) {
          errorMsg = 'Upload timeout. Check your network.';
        }

        LoadingManager.hide('error', errorMsg);
      })
      .uploadToImgur(playerName, base64);
  };

  reader.onerror = function() {
    isUploading = false;
    LoadingManager.hide('error', 'Failed to read file');
  };

  reader.readAsDataURL(file);
}

function closeOverlay() {
  document.getElementById('overlay').classList.remove('show');
}

function showLoading() {
  const list = currentView === 'key'
    ? document.getElementById('keyPlayerList')
    : document.getElementById('tablePlayerList');
  list.innerHTML = '<div class="loading">Processing...</div>';
}

function hideLoading() {
  // Î¶¨Î†åÎçîÎßÅÏúºÎ°ú Ï≤òÎ¶¨Îê®
}

/* ===== Introduction Toggle (Phase 3.5.1) ===== */

/**
 * ÌÇ§ ÌîåÎ†àÏù¥Ïñ¥ Introduction Ï≤¥ÌÅ¨Î∞ïÏä§ ÌÜ†Í∏Ä
 * @param {string} playerName - ÌîåÎ†àÏù¥Ïñ¥ Name
 * @param {boolean} isChecked - Ï≤¥ÌÅ¨ Ïó¨Î∂Ä
 */
function toggleIntroduction(playerName, isChecked) {
  console.log('üîÑ toggleIntroduction:', playerName, isChecked);

  google.script.run
    .withSuccessHandler(response => {
      if (!response.success) {
        LoadingManager.showToast('Failed to update introduction status: ' + (response.error?.message || 'Unknown error'), 'error');
        // Ïã§Ìå® Ïãú Ï≤¥ÌÅ¨Î∞ïÏä§ ÏõêÎûò ÏÉÅÌÉúÎ°ú Î≥µÏõê (ÌôîÎ©¥ Î¶¨ÌîÑÎ†àÏãú)
        loadKeyPlayers();
        return;
      }

      // ÏÑ±Í≥µ ÌÜ†Ïä§Ìä∏ (Í∞ÑÎã®ÌïòÍ≤å)
      const status = isChecked ? 'checked' : 'unchecked';
      LoadingManager.showToast('‚úÖ ' + playerName + ' Introduction ' + status, 'success', 2000);
    })
    .withFailureHandler(err => {
      LoadingManager.showToast('Network error: ' + err.message, 'error');
      loadKeyPlayers(); // Ïã§Ìå® Ïãú Î≥µÏõê
    })
    .updateIntroduction(playerName, isChecked);
}

/* ===== Unified Loading Manager (Single UI Pattern) ===== */
const LoadingManager = {
  _active: false,
  _timeoutId: null,
  _cancelCallback: null,

  /**
   * Î°úÎî© ÌëúÏãú (Îã®Ïùº ÌÜµÌï© UI)
   * @param {Object} options
   * @param {string} options.message - Î©îÏù∏ Î©îÏãúÏßÄ (Ïòà: "Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë")
   * @param {string} options.hint - ÌûåÌä∏ Î©îÏãúÏßÄ (Ïòà: "Please wait")
   * @param {boolean} options.progress - ÏßÑÌñâÎ•† Î∞î ÌëúÏãú Ïó¨Î∂Ä
   * @param {number} options.timeout - ÌÉÄÏûÑÏïÑÏõÉ (ms, 0=Î¨¥Ï†úÌïú)
   * @param {boolean} options.cancelable - Cancel Î≤ÑÌäº ÌëúÏãú Ïó¨Î∂Ä
   * @param {Function} options.onCancel - Cancel Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú ÏΩúÎ∞±
   */
  show(options = {}) {
    const {
      message = 'Loading...',
      hint = '',
      progress = false,
      timeout = 30000,
      cancelable = false,
      onCancel = null
    } = options;

    const lock = document.getElementById('screenLock');
    if (!lock) return;

    // UI ÏóÖÎç∞Ïù¥Ìä∏
    lock.querySelector('.lockText').textContent = message;
    lock.querySelector('.lockHint').textContent = hint;

    const progressEl = lock.querySelector('.lockProgress');
    const progressTextEl = lock.querySelector('.lockProgressText');
    const cancelBtn = lock.querySelector('.lockCancel');

    // ÏßÑÌñâÎ•† Î∞î
    if (progress) {
      progressEl.classList.add('show');
      progressTextEl.classList.add('show');
      this.setProgress(0);
    } else {
      progressEl.classList.remove('show');
      progressTextEl.classList.remove('show');
    }

    // Cancel Î≤ÑÌäº
    if (cancelable && onCancel) {
      cancelBtn.classList.add('show');
      this._cancelCallback = onCancel;
      cancelBtn.onclick = () => this._handleCancel();
    } else {
      cancelBtn.classList.remove('show');
      cancelBtn.onclick = null;
    }

    // ÌôîÎ©¥ ÌëúÏãú
    lock.classList.add('active');
    document.body.style.overflow = 'hidden';
    this._active = true;

    // ÌÉÄÏûÑÏïÑÏõÉ ÏÑ§Ï†ï
    if (timeout > 0) {
      this._timeoutId = setTimeout(() => this._handleTimeout(), timeout);
    }
  },

  /**
   * Î°úÎî© Ïà®ÍπÄ
   * @param {string} result - 'success' | 'error' | null (ÏïåÎ¶º ÏóÜÏùå)
   * @param {string} message - Í≤∞Í≥º Î©îÏãúÏßÄ
   */
  hide(result = null, message = '') {
    const lock = document.getElementById('screenLock');
    if (!lock) return;

    // ÌÉÄÏûÑÏïÑÏõÉ Cancel
    if (this._timeoutId) {
      clearTimeout(this._timeoutId);
      this._timeoutId = null;
    }

    // ÌôîÎ©¥ Ïà®ÍπÄ
    lock.classList.remove('active');
    document.body.style.overflow = '';
    this._active = false;
    this._cancelCallback = null;

    // Í≤∞Í≥º ÌÜ†Ïä§Ìä∏ ÌëúÏãú
    if (result && message) {
      this.showToast(message, result);
    }
  },

  /**
   * ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏ (0-100)
   */
  setProgress(percent) {
    if (!this._active) return;

    const progressBar = document.querySelector('.lockProgressBar');
    const progressText = document.querySelector('.lockProgressText');

    if (progressBar) {
      progressBar.style.width = percent + '%';
    }
    if (progressText) {
      progressText.textContent = Math.round(percent) + '%';
    }
  },

  /**
   * ÌÜ†Ïä§Ìä∏ ÏïåÎ¶º (Í∞ÑÎã®Ìïú ÏÑ±Í≥µ/Ïã§Ìå® Î©îÏãúÏßÄ)
   * @param {string} message - Î©îÏãúÏßÄ
   * @param {string} type - 'success' | 'error' | 'warning'
   * @param {number} duration - ÌëúÏãú ÏãúÍ∞Ñ (ms)
   */
  showToast(message, type = 'success', duration = 3000) {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    // Ïï†ÎãàÎ©îÏù¥ÏÖò
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, duration);
  },

  /**
   * ÌÉÄÏûÑÏïÑÏõÉ Ï≤òÎ¶¨ (30Ï¥à Í≤ΩÍ≥º Ïãú)
   */
  _handleTimeout() {
    this.showToast('Server response is delayed. Please check your network.', 'warning', 5000);
  },

  /**
   * Cancel Î≤ÑÌäº Ï≤òÎ¶¨
   */
  _handleCancel() {
    if (this._cancelCallback) {
      this._cancelCallback();
    }
    this.hide(null, '');
  },

  /**
   * ÌòÑÏû¨ Î°úÎî© Ï§ëÏù∏ÏßÄ ÌôïÏù∏
   */
  isActive() {
    return this._active;
  }
};

/* ===== Reusable Server Call Helper (ÏΩîÎìú Ïû¨ÏÇ¨Ïö© Ìå®ÌÑ¥) ===== */
/**
 * ÏÑúÎ≤Ñ Ìò∏Ï∂ú Í≥µÌÜµ ÎûòÌçº (Î°úÎî© UI + ÏóêÎü¨ Ï≤òÎ¶¨ ÏûêÎèôÌôî)
 * @param {Object} options
 * @param {string} options.action - ÏÑúÎ≤Ñ Ìï®Ïàò Name (Ïòà: 'updatePlayerChips')
 * @param {Array} options.params - ÏÑúÎ≤Ñ Ìï®Ïàò ÌååÎùºÎØ∏ÌÑ∞ Î∞∞Ïó¥
 * @param {string} options.loadingMessage - Î°úÎî© Î©îÏãúÏßÄ
 * @param {string} options.successMessage - ÏÑ±Í≥µ ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ (nullÏù¥Î©¥ ÌëúÏãú ÏïàÌï®)
 * @param {Function} options.onSuccess - ÏÑ±Í≥µ Ïãú Add ÏûëÏóÖ (ÏÑ†ÌÉù)
 */
function callServerWithLoading(options) {
  const {
    action,
    params = [],
    loadingMessage = 'Processing...',
    successMessage = null,
    onSuccess = null
  } = options;

  // Î°úÎî© ÌëúÏãú
  LoadingManager.show({ message: loadingMessage, timeout: 30000 });

  // ÏÑúÎ≤Ñ Ìï®Ïàò ÎèôÏ†Å Ìò∏Ï∂ú
  google.script.run
    .withSuccessHandler(response => {
      if (!response.success) {
        LoadingManager.hide('error', 'Error: ' + (response.error?.message || 'Operation failed'));
        return;
      }

      // ÏÑ±Í≥µ Ï≤òÎ¶¨
      if (successMessage) {
        LoadingManager.hide('success', successMessage);
      } else {
        LoadingManager.hide();
      }

      // Add ÏûëÏóÖ Ïã§Ìñâ
      if (onSuccess) {
        onSuccess(response);
      }

      // ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ®
      if (currentView === 'key') {
        loadKeyPlayers();
      } else {
        loadTablePlayers(currentTableId);
      }
    })
    .withFailureHandler(err => {
      LoadingManager.hide('error', 'Network error: ' + err.message);
    })
    [action](...params);
}

/* ===== Legacy API (Í∏∞Ï°¥ ÏΩîÎìú Ìò∏ÌôòÏÑ± Ïú†ÏßÄ) ===== */
function showLoading() {
  LoadingManager.show({ message: 'Processing...' });
}

function hideLoading() {
  LoadingManager.hide();
}

function lockScreen() {
  LoadingManager.show({ message: 'Saving photo...' });
}

function unlockScreen() {
  LoadingManager.hide();
}
</script>
</body>
</html>